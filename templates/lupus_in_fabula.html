<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üê∫ Lupus in Fabula</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Arial', sans-serif;
            background: linear-gradient(135deg, #2c3e50 0%, #34495e 50%, #1a252f 100%);
            min-height: 100vh;
            color: white;
            overflow-x: hidden;
        }

        .container {
            max-width: 900px;
            margin: 0 auto;
            padding: 20px;
        }

        /* Header del gioco */
        .game-header {
            text-align: center;
            margin-bottom: 30px;
            padding: 25px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 25px;
            backdrop-filter: blur(15px);
            border: 1px solid rgba(255, 255, 255, 0.2);
            animation: slideInDown 0.8s ease-out;
            position: relative;
            overflow: hidden;
        }

        .game-header::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.1), transparent);
            animation: shine 3s infinite;
        }

        @keyframes shine {
            0% { left: -100%; }
            100% { left: 100%; }
        }

        @keyframes slideInDown {
            from {
                opacity: 0;
                transform: translateY(-30px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .game-header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
            background: linear-gradient(45deg, #e74c3c, #c0392b);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            position: relative;
            z-index: 1;
        }

        .game-header p {
            font-size: 1.1em;
            opacity: 0.9;
            position: relative;
            z-index: 1;
        }

        /* Status del gioco */
        .game-status {
            text-align: center;
            margin-bottom: 30px;
            padding: 20px;
            background: rgba(52, 152, 219, 0.2);
            border: 2px solid #3498db;
            border-radius: 15px;
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0% {
                box-shadow: 0 0 0 0 rgba(52, 152, 219, 0.7);
            }
            70% {
                box-shadow: 0 0 0 10px rgba(52, 152, 219, 0);
            }
            100% {
                box-shadow: 0 0 0 0 rgba(52, 152, 219, 0);
            }
        }

        .waiting-status {
            background: rgba(241, 196, 15, 0.2);
            border-color: #f1c40f;
        }

        .night-phase {
            background: rgba(44, 62, 80, 0.8);
            border-color: #2c3e50;
        }

        .day-phase {
            background: rgba(241, 196, 15, 0.3);
            border-color: #f1c40f;
        }

        .voting-phase {
            background: rgba(231, 76, 60, 0.3);
            border-color: #e74c3c;
        }

        /* Info ruolo */
        .role-info {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 20px;
            padding: 25px;
            margin-bottom: 30px;
            backdrop-filter: blur(15px);
            border: 2px solid transparent;
            transition: all 0.3s ease;
        }

        .role-info.lupi {
            border-color: #e74c3c;
            background: rgba(231, 76, 60, 0.2);
        }

        .role-info.cittadini {
            border-color: #3498db;
            background: rgba(52, 152, 219, 0.2);
        }

        .role-emoji {
            font-size: 3em;
            text-align: center;
            margin-bottom: 15px;
            animation: bounce 2s infinite;
        }

        @keyframes bounce {
            0%, 20%, 50%, 80%, 100% { transform: translateY(0); }
            40% { transform: translateY(-10px); }
            60% { transform: translateY(-5px); }
        }

        .role-name {
            font-size: 1.8em;
            font-weight: bold;
            text-align: center;
            margin-bottom: 10px;
            color: #ffd700;
        }

        .role-description {
            text-align: center;
            opacity: 0.9;
            line-height: 1.6;
            margin-bottom: 15px;
        }

        .role-team {
            text-align: center;
            padding: 8px 20px;
            border-radius: 20px;
            font-weight: bold;
            display: inline-block;
            margin: 0 auto;
        }

        .team-lupi {
            background: rgba(231, 76, 60, 0.3);
            border: 1px solid #e74c3c;
            color: #e74c3c;
        }

        .team-cittadini {
            background: rgba(52, 152, 219, 0.3);
            border: 1px solid #3498db;
            color: #3498db;
        }

        /* Timer */
        .timer-container {
            position: fixed;
            top: 20px;
            right: 20px;
            background: rgba(231, 76, 60, 0.9);
            color: white;
            padding: 15px 25px;
            border-radius: 50px;
            font-weight: bold;
            font-size: 1.3em;
            box-shadow: 0 10px 25px rgba(0,0,0,0.3);
            z-index: 1000;
            transition: all 0.3s ease;
        }

        .timer-container.warning {
            background: rgba(255, 193, 7, 0.9);
            animation: pulse-warning 1s infinite;
        }

        .timer-container.danger {
            background: rgba(231, 76, 60, 0.9);
            animation: pulse-danger 0.5s infinite;
        }

        @keyframes pulse-warning {
            0% { transform: scale(1); }
            50% { transform: scale(1.05); }
            100% { transform: scale(1); }
        }

        @keyframes pulse-danger {
            0% { transform: scale(1); }
            50% { transform: scale(1.1); }
            100% { transform: scale(1); }
        }

        /* Area di gioco principale */
        .game-area {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 25px;
            padding: 30px;
            backdrop-filter: blur(15px);
            border: 1px solid rgba(255, 255, 255, 0.2);
            margin-bottom: 30px;
            position: relative;
            overflow: hidden;
        }

        /* Sezione azioni */
        .actions-section {
            margin-bottom: 30px;
        }

        .actions-section h3 {
            margin-bottom: 20px;
            color: #ffd700;
            text-align: center;
            font-size: 1.5em;
        }

        .players-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }

        .player-option {
            background: rgba(255, 255, 255, 0.1);
            border: 2px solid transparent;
            border-radius: 15px;
            padding: 15px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
        }

        .player-option::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.2), transparent);
            transition: left 0.5s;
        }

        .player-option:hover::before {
            left: 100%;
        }

        .player-option:hover {
            border-color: #ffd700;
            background: rgba(255, 255, 255, 0.2);
            transform: translateY(-5px) scale(1.02);
            box-shadow: 0 15px 30px rgba(255, 215, 0, 0.3);
        }

        .player-option.selected {
            border-color: #e74c3c;
            background: rgba(231, 76, 60, 0.3);
            transform: translateY(-3px) scale(1.02);
            box-shadow: 0 15px 30px rgba(231, 76, 60, 0.4);
        }

        .player-option.dead {
            opacity: 0.4;
            cursor: not-allowed;
            filter: grayscale(100%);
        }

        .player-photo {
            width: 60px;
            height: 60px;
            border-radius: 50%;
            margin: 0 auto 10px;
            background: rgba(255, 255, 255, 0.2);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.5em;
            overflow: hidden;
        }

        .player-photo img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .player-name {
            font-weight: bold;
            margin-bottom: 5px;
        }

        .player-status {
            font-size: 0.8em;
            opacity: 0.8;
        }

        /* Pulsanti di azione */
        .action-btn {
            background: linear-gradient(45deg, #e74c3c, #c0392b);
            color: white;
            border: none;
            padding: 15px 30px;
            border-radius: 50px;
            font-size: 1.1em;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.4s ease;
            position: relative;
            overflow: hidden;
            display: block;
            margin: 20px auto;
            min-width: 200px;
        }

        .action-btn::before {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            width: 0;
            height: 0;
            background: rgba(255, 255, 255, 0.2);
            border-radius: 50%;
            transform: translate(-50%, -50%);
            transition: all 0.5s ease;
        }

        .action-btn:hover::before {
            width: 300px;
            height: 300px;
        }

        .action-btn:hover {
            transform: scale(1.05);
            box-shadow: 0 15px 30px rgba(231, 76, 60, 0.4);
        }

        .action-btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
            background: #95a5a6;
        }

        .action-btn.vote {
            background: linear-gradient(45deg, #f39c12, #e67e22);
        }

        .action-btn.vote:hover {
            box-shadow: 0 15px 30px rgba(243, 156, 18, 0.4);
        }

        .action-btn.protect {
            background: linear-gradient(45deg, #27ae60, #2ecc71);
        }

        .action-btn.protect:hover {
            box-shadow: 0 15px 30px rgba(39, 174, 96, 0.4);
        }

        .action-btn.investigate {
            background: linear-gradient(45deg, #9b59b6, #8e44ad);
        }

        .action-btn.investigate:hover {
            box-shadow: 0 15px 30px rgba(155, 89, 182, 0.4);
        }

        /* Chat lupi */
        .wolves-chat {
            background: rgba(231, 76, 60, 0.2);
            border: 2px solid #e74c3c;
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 20px;
        }

        .wolves-list {
            display: flex;
            gap: 15px;
            margin-bottom: 15px;
            flex-wrap: wrap;
        }

        .wolf-item {
            display: flex;
            align-items: center;
            background: rgba(255, 255, 255, 0.1);
            padding: 10px 15px;
            border-radius: 20px;
        }

        .wolf-photo {
            width: 30px;
            height: 30px;
            border-radius: 50%;
            margin-right: 10px;
            background: rgba(255, 255, 255, 0.2);
            display: flex;
            align-items: center;
            justify-content: center;
            overflow: hidden;
        }

        .wolf-photo img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        /* Risultati e messaggi */
        .result-message {
            padding: 20px;
            border-radius: 15px;
            margin: 20px 0;
            text-align: center;
            font-weight: bold;
            font-size: 1.2em;
            animation: fadeIn 0.5s ease-in;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .result-success {
            background: rgba(39, 174, 96, 0.3);
            border: 2px solid #27ae60;
            color: #2ecc71;
        }

        .result-info {
            background: rgba(52, 152, 219, 0.3);
            border: 2px solid #3498db;
            color: #3498db;
        }

        .result-warning {
            background: rgba(241, 196, 15, 0.3);
            border: 2px solid #f1c40f;
            color: #f1c40f;
        }

        /* Controlli */
        .controls {
            display: flex;
            justify-content: center;
            gap: 20px;
            margin-top: 30px;
            flex-wrap: wrap;
        }

        .btn {
            background: linear-gradient(45deg, #3498db, #2980b9);
            color: white;
            border: none;
            padding: 15px 30px;
            border-radius: 50px;
            font-size: 1.1em;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.4s ease;
            text-decoration: none;
            display: inline-block;
        }

        .btn:hover {
            transform: scale(1.05);
            box-shadow: 0 10px 20px rgba(52, 152, 219, 0.4);
        }

        .btn-secondary {
            background: linear-gradient(45deg, #95a5a6, #7f8c8d);
        }

        .btn-secondary:hover {
            box-shadow: 0 10px 20px rgba(149, 165, 166, 0.4);
        }

        /* Notification */
        .notification {
            position: fixed;
            top: 30px;
            right: 30px;
            padding: 20px 25px;
            border-radius: 15px;
            color: white;
            font-weight: bold;
            z-index: 1000;
            transform: translateX(400px);
            transition: transform 0.4s ease;
            box-shadow: 0 10px 25px rgba(0,0,0,0.3);
            max-width: 350px;
        }

        .notification.success {
            background: linear-gradient(45deg, #27ae60, #2ecc71);
        }

        .notification.error {
            background: linear-gradient(45deg, #e74c3c, #c0392b);
        }

        .notification.info {
            background: linear-gradient(45deg, #3498db, #2980b9);
        }

        .notification.show {
            transform: translateX(0);
        }

        /* Responsive */
        @media (max-width: 768px) {
            .container {
                padding: 15px;
            }

            .game-header h1 {
                font-size: 2em;
            }

            .players-grid {
                grid-template-columns: repeat(2, 1fr);
            }

            .controls {
                flex-direction: column;
                align-items: center;
            }

            .timer-container {
                position: static;
                margin-bottom: 20px;
                display: inline-block;
            }

            .wolves-list {
                justify-content: center;
            }
        }

        @media (max-width: 480px) {
            .players-grid {
                grid-template-columns: 1fr;
            }

            .action-btn {
                min-width: auto;
                width: 100%;
            }

            .notification {
                right: 15px;
                left: 15px;
                transform: translateY(-200px);
            }

            .notification.show {
                transform: translateY(0);
            }
        }

        /* Animazioni speciali */
        .dead-reveal {
            animation: deathReveal 2s ease-in-out;
        }

        @keyframes deathReveal {
            0% { transform: scale(1) rotate(0deg); opacity: 1; }
            25% { transform: scale(1.1) rotate(-2deg); }
            50% { transform: scale(1.05) rotate(1deg); }
            75% { transform: scale(0.95) rotate(-1deg); }
            100% { transform: scale(0.9) rotate(0deg); opacity: 0.4; filter: grayscale(100%); }
        }

        .phase-transition {
            animation: phaseChange 1s ease-in-out;
        }

        @keyframes phaseChange {
            0% { opacity: 1; transform: scale(1); }
            50% { opacity: 0.7; transform: scale(1.05); }
            100% { opacity: 1; transform: scale(1); }
        }
    </style>
</head>
<body>
    <!-- Timer -->
    <div class="timer-container" id="timer">
        ‚è±Ô∏è --:--
    </div>

    <div class="container">
        <!-- Header del gioco -->
        <div class="game-header">
            <h1>üê∫ Lupus in Fabula</h1>
            <p>La notte nasconde molti segreti... Chi sopravviver√†?</p>
        </div>

        <!-- Status del gioco -->
        <div class="game-status waiting-status" id="game-status">
            <h3>‚è≥ In attesa...</h3>
            <p>Il gioco inizier√† a breve!</p>
        </div>

        <!-- Info ruolo -->
        <div class="role-info" id="role-info" style="display: none;">
            <div class="role-emoji" id="role-emoji">üé≠</div>
            <div class="role-name" id="role-name">Il tuo ruolo</div>
            <div class="role-description" id="role-description">Descrizione del ruolo</div>
            <div style="text-align: center;">
                <span class="role-team" id="role-team">Team</span>
            </div>
        </div>

        <!-- Chat lupi (solo per i lupi) -->
        <div class="wolves-chat" id="wolves-chat" style="display: none;">
            <h3>üê∫ I tuoi compagni lupi:</h3>
            <div class="wolves-list" id="wolves-list">
                <!-- Lupi verranno aggiunti dinamicamente -->
            </div>
            <p style="font-style: italic; opacity: 0.8;">Coordinate le vostre azioni durante la notte!</p>
        </div>

        <!-- Area principale del gioco -->
        <div class="game-area" id="game-area" style="display: none;">
            <!-- Sezione azioni -->
            <div class="actions-section" id="actions-section">
                <h3 id="action-title">Scegli la tua azione</h3>

                <!-- Griglia giocatori per selezione -->
                <div class="players-grid" id="players-grid">
                    <!-- Giocatori verranno caricati dinamicamente -->
                </div>

                <!-- Pulsante azione -->
                <button class="action-btn" id="action-btn" onclick="executeAction()" disabled>
                    Conferma Azione
                </button>
            </div>

            <!-- Messaggi di risultato -->
            <div id="result-messages">
                <!-- Risultati verranno mostrati qui -->
            </div>
        </div>

        <!-- Controlli -->
        <div class="controls">
            <a href="/dashboard" class="btn btn-secondary">
                üè† Torna alla Dashboard
            </a>
            <button class="btn" onclick="refreshGame()">
                üîÑ Aggiorna
            </button>
        </div>
    </div>

    <script>// ========================================
// LUPUS IN FABULA - JAVASCRIPT COMPLETO
// Versione con timer automatico da 30 secondi
// ========================================

let gameData = null;
let selectedTarget = null;
let refreshInterval = null;
let lastPhase = null;
let lastTurn = null;

// INIZIALIZZAZIONE
document.addEventListener('DOMContentLoaded', function() {
    addTimerAnimations();
    loadGameStatus();
    startPeriodicUpdates();

    // Messaggio di benvenuto con nuovo sistema
    showResult('üöÄ Sistema aggiornato: Timer da 30 secondi e avanzamento automatico!', 'success');
});

// AGGIORNA CSS PER ANIMAZIONI TIMER
function addTimerAnimations() {
    const timerAnimationCSS = `
        <style id="timer-animations">
        @keyframes pulse {
            0% { opacity: 1; transform: scale(1); }
            50% { opacity: 0.7; transform: scale(1.05); }
            100% { opacity: 1; transform: scale(1); }
        }

        @keyframes blink {
            0%, 50% { opacity: 1; }
            51%, 100% { opacity: 0.3; }
        }

        .timer-container.warning {
            background: linear-gradient(45deg, #f39c12, #e67e22) !important;
            box-shadow: 0 0 15px rgba(243, 156, 18, 0.6);
            border: 2px solid #f39c12;
        }

        .timer-container.danger {
            background: linear-gradient(45deg, #e74c3c, #c0392b) !important;
            box-shadow: 0 0 20px rgba(231, 76, 60, 0.8);
            border: 2px solid #fff;
            color: white !important;
            font-weight: bold;
        }

        .result-message.warning {
            background-color: #f39c12;
            color: white;
            padding: 12px;
            border-radius: 8px;
            margin: 5px 0;
            font-weight: bold;
            animation: slideIn 0.3s ease-out;
        }

        @keyframes slideIn {
            from { transform: translateX(-100%); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }
        </style>
    `;

    // Inserisci CSS nel head se non esiste gi√†
    if (!document.getElementById('timer-animations')) {
        document.head.insertAdjacentHTML('beforeend', timerAnimationCSS);
    }
}

// CONTROLLO AUTOMATICO OGNI 2 SECONDI
function startPeriodicUpdates() {
    // Controllo ogni 2 secondi per risposta pi√π rapida
    refreshInterval = setInterval(() => {
        loadGameStatus();
        // Controllo automatico per avanzamento fasi
        checkAutoAdvancement();
    }, 2000);
}

// CONTROLLO AUTOMATICO AVANZAMENTO
function checkAutoAdvancement() {
    fetch('/api/lupus-auto-check', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.status === 'phase_advanced') {
            // Tempo scaduto, fase avanzata automaticamente
            loadGameStatus();
            showResult('‚è∞ Tempo scaduto! Fase avanzata automaticamente (30s)', 'warning');
        } else if (data.status === 'auto_advanced') {
            // Tutti hanno completato, avanzamento rapido
            loadGameStatus();
            showResult('‚úÖ Tutti hanno completato! Avanzamento automatico', 'success');
        }
    })
    .catch(error => {
        // Errore silenzioso per non disturbare l'esperienza
        console.log('Controllo automatico fallito:', error);
    });
}

// CARICAMENTO STATO GIOCO
function loadGameStatus() {
    fetch('/api/lupus-status')
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                gameData = data;

                // Aggiorna interfaccia in base allo stato
                if (data.stato === 'morto' || data.stato === 'eliminato') {
                    showDeadPlayerInterface(data.stato);
                } else if (data.stato === 'ended') {
                    showGameEndedInterface(data);
                } else {
                    updateGameInterface(data);
                }

                // Notifica cambio fase
                if (lastPhase && lastPhase !== data.fase_corrente) {
                    notifyPhaseChange(data.fase_corrente);
                }
                lastPhase = data.fase_corrente;
                lastTurn = data.turno_numero;

            } else {
                showError('‚ùå Errore caricamento stato: ' + data.error);
            }
        })
        .catch(error => {
            showError('üîå Errore di connessione');
            console.error('Errore:', error);
        });
}

// AGGIORNAMENTO INTERFACCIA PRINCIPALE
function updateGameInterface(data) {
    // Aggiorna header informazioni
    updateGameHeader(data);

    // Aggiorna timer
    if (data.tempo_rimanente !== undefined) {
        updateTimer(data.tempo_rimanente, data.fase_corrente);

        // Promemoria urgenti
        urgentActionReminder(data.tempo_rimanente);
    }

    // Aggiorna contenuto in base alla fase
    const gameArea = document.getElementById('game-area');

    if (data.fase_corrente === 'night') {
        if (data.ruolo.team === 'lupi' || ['Veggente', 'Guardia'].includes(data.ruolo.nome)) {
            if (data.ha_fatto_azione) {
                showWaitingMessage('night', true, false);
            } else {
                showNightActionInterface(data);
            }
        } else {
            showWaitingMessage('night', false, false);
        }
    } else if (data.fase_corrente === 'day') {
        showDayInterface(data);
    } else if (data.fase_corrente === 'voting') {
        if (data.ha_votato) {
            showWaitingMessage('voting', false, true);
        } else {
            showVotingInterface(data);
        }
    } else if (data.fase_corrente === 'setup') {
        showWaitingForPlayersInterface(data);
    }

    // Aggiorna lista eventi
    updateEventsList(data.eventi_recenti);
}

// AGGIORNAMENTO HEADER
function updateGameHeader(data) {
    document.getElementById('player-name').textContent = data.nome;
    document.getElementById('player-role').textContent = data.ruolo.nome;
    document.getElementById('player-role').className = `role-badge ${data.ruolo.team}`;
    document.getElementById('turn-number').textContent = `Turno ${data.turno_numero}`;
    document.getElementById('players-alive').textContent = `${data.giocatori_vivi}/${data.totale_giocatori} vivi`;
}

// TIMER AGGRESSIVO CON ANIMAZIONI
function updateTimer(timeRemaining, phase) {
    const timer = document.getElementById('timer');

    if (timeRemaining <= 0) {
        timer.textContent = '‚è±Ô∏è TEMPO SCADUTO!';
        timer.className = 'timer-container danger';
        timer.style.animation = 'blink 0.5s infinite';
        return;
    }

    const minutes = Math.floor(timeRemaining / 60);
    const seconds = Math.floor(timeRemaining % 60);
    const timeStr = `${minutes}:${seconds.toString().padStart(2, '0')}`;

    const phaseEmoji = {
        'night': 'üåô',
        'day': '‚òÄÔ∏è',
        'voting': 'üó≥Ô∏è',
        'setup': '‚öôÔ∏è'
    }[phase] || '‚è±Ô∏è';

    timer.textContent = `${phaseEmoji} ${timeStr}`;

    // Timer aggressivo per spingere all'azione (30 secondi totali)
    if (timeRemaining <= 5) {
        timer.className = 'timer-container danger';
        timer.style.animation = 'pulse 0.3s infinite';
        timer.style.fontSize = '1.3em';
    } else if (timeRemaining <= 10) {
        timer.className = 'timer-container warning';
        timer.style.animation = 'pulse 0.6s infinite';
        timer.style.fontSize = '1.2em';
    } else if (timeRemaining <= 15) {
        timer.className = 'timer-container warning';
        timer.style.animation = 'pulse 1s infinite';
        timer.style.fontSize = '1.1em';
    } else {
        timer.className = 'timer-container';
        timer.style.animation = 'none';
        timer.style.fontSize = '1em';
    }
}

// PROMEMORIA URGENTI
function urgentActionReminder(timeLeft) {
    if (timeLeft <= 10 && timeLeft > 0 && gameData) {
        const phase = gameData.fase_corrente;
        let actionNeeded = '';

        if (phase === 'night' && gameData.ruolo?.team === 'lupi' && !gameData.ha_fatto_azione) {
            actionNeeded = 'SCEGLI CHI ELIMINARE!';
        } else if (phase === 'night' && gameData.ruolo?.nome === 'Veggente' && !gameData.ha_fatto_azione) {
            actionNeeded = 'SCEGLI CHI INVESTIGARE!';
        } else if (phase === 'night' && gameData.ruolo?.nome === 'Guardia' && !gameData.ha_fatto_azione) {
            actionNeeded = 'SCEGLI CHI PROTEGGERE!';
        } else if (phase === 'voting' && !gameData.ha_votato) {
            actionNeeded = 'VOTA ADESSO!';
        }

        if (actionNeeded) {
            showResult(`üö® ${timeLeft}s rimasti - ${actionNeeded}`, 'warning');
        }
    }
}

// INTERFACCE PER DIVERSE FASI

// INTERFACCIA NOTTE
function showNightActionInterface(data) {
    const actionsSection = document.getElementById('actions-section');
    actionsSection.style.display = 'block';

    let actionTitle = '';
    let actionDescription = '';

    if (data.ruolo.team === 'lupi') {
        actionTitle = 'üê∫ Azione Lupi';
        actionDescription = 'Scegli chi eliminare questa notte (30 secondi!)';
    } else if (data.ruolo.nome === 'Veggente') {
        actionTitle = 'üîÆ Visione';
        actionDescription = 'Scegli chi investigare per scoprire il suo ruolo (30 secondi!)';
    } else if (data.ruolo.nome === 'Guardia') {
        actionTitle = 'üõ°Ô∏è Protezione';
        actionDescription = 'Scegli chi proteggere dagli attacchi (30 secondi!)';
    }

    actionsSection.innerHTML = `
        <div class="actions-container">
            <h3>${actionTitle}</h3>
            <p style="color: #e67e22; font-weight: bold; margin-bottom: 20px;">‚ö° ${actionDescription}</p>
            <div id="target-selection" class="target-grid">
                ${data.altri_giocatori.map(player => `
                    <div class="player-card ${player.stato}" onclick="selectTarget(${player.id})">
                        <div class="player-name">${player.nome}</div>
                        <div class="player-status">${player.stato === 'vivo' ? '‚úÖ Vivo' : 'üíÄ Morto'}</div>
                    </div>
                `).join('')}
            </div>
            <button id="action-btn" onclick="submitAction()" disabled>
                ${getActionButtonText()}
            </button>
        </div>
    `;
}

// INTERFACCIA GIORNO
function showDayInterface(data) {
    const actionsSection = document.getElementById('actions-section');
    actionsSection.style.display = 'block';

    actionsSection.innerHTML = `
        <div class="actions-container">
            <h3>‚òÄÔ∏è Discussione Diurna</h3>
            <p style="color: #e67e22; font-weight: bold; margin-bottom: 20px;">
                üí¨ Avete solo 30 secondi per discutere prima della votazione!
            </p>
            <div style="background: rgba(52, 152, 219, 0.1); padding: 20px; border-radius: 10px; text-align: center;">
                <h4 style="color: #3498db; margin-bottom: 15px;">üéØ Situazione Attuale</h4>
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(120px, 1fr)); gap: 10px; margin-bottom: 15px;">
                    <div style="background: rgba(46, 204, 113, 0.2); padding: 10px; border-radius: 8px;">
                        <strong>${data.giocatori_vivi}</strong><br>
                        <small>Vivi</small>
                    </div>
                    <div style="background: rgba(231, 76, 60, 0.2); padding: 10px; border-radius: 8px;">
                        <strong>${data.totale_giocatori - data.giocatori_vivi}</strong><br>
                        <small>Morti</small>
                    </div>
                    <div style="background: rgba(155, 89, 182, 0.2); padding: 10px; border-radius: 8px;">
                        <strong>T${data.turno_numero}</strong><br>
                        <small>Turno</small>
                    </div>
                </div>
                <p style="font-size: 1.1em; margin: 0;">
                    Usate il tempo per discutere chi sospettate!<br>
                    <span style="color: #e74c3c; font-weight: bold;">Tra poco si vota!</span>
                </p>
            </div>
        </div>
    `;
}

// INTERFACCIA VOTAZIONE
function showVotingInterface(data) {
    const actionsSection = document.getElementById('actions-section');
    actionsSection.style.display = 'block';

    actionsSection.innerHTML = `
        <div class="actions-container">
            <h3>üó≥Ô∏è Votazione</h3>
            <p style="color: #e74c3c; font-weight: bold; margin-bottom: 20px;">
                ‚ö° Chi volete eliminare? Avete solo 30 secondi per decidere!
            </p>
            <div id="target-selection" class="target-grid">
                ${data.altri_giocatori.filter(p => p.stato === 'vivo').map(player => `
                    <div class="player-card votable" onclick="selectTarget(${player.id})">
                        <div class="player-name">${player.nome}</div>
                        <div class="player-status">üë§ Candidato</div>
                    </div>
                `).join('')}
            </div>
            <button id="action-btn" onclick="submitVote()" disabled>
                Vota Giocatore
            </button>
        </div>
    `;
}

// INTERFACCIA ATTESA
function showWaitingMessage(phase, haFattoAzione, haVotato) {
    const actionsSection = document.getElementById('actions-section');
    actionsSection.style.display = 'block';

    let message = '';
    let timeInfo = 'Avanzamento automatico in max 30 secondi!';

    if (phase === 'night') {
        if (haFattoAzione) {
            message = 'üåô Azione completata! Aspettando gli altri...';
            timeInfo = 'Se tutti completano, si avanza subito!';
        } else {
            message = 'üåô √à notte, rilassati e aspetta...';
            timeInfo = 'I ruoli speciali stanno agendo (30s max)';
        }
    } else if (phase === 'day') {
        message = '‚òÄÔ∏è Discussione in corso - Decidete in fretta!';
        timeInfo = 'Solo 30 secondi per discutere, poi si vota!';
    } else if (phase === 'voting') {
        if (haVotato) {
            message = 'üó≥Ô∏è Voto registrato! Aspettando gli altri...';
            timeInfo = 'Se tutti votano, si procede immediatamente!';
        } else {
            message = 'üó≥Ô∏è Tempo di votare!';
            timeInfo = 'Solo 30 secondi per votare, poi si va avanti!';
        }
    }

    actionsSection.innerHTML = `
        <div style="text-align: center; padding: 25px; background: rgba(52, 152, 219, 0.1); border-radius: 15px; border: 2px solid #3498db;">
            <h3 style="color: #3498db; margin-bottom: 10px;">${message}</h3>
            <p style="font-size: 1.1em; color: #e67e22; font-weight: bold; margin-bottom: 15px;">
                ‚ö° ${timeInfo}
            </p>
            <div style="background: rgba(231, 76, 60, 0.1); padding: 15px; border-radius: 10px; margin-bottom: 15px;">
                <p style="color: #e74c3c; font-weight: bold; margin: 0;">
                    üö® NUOVO: Timer veloce da 30 secondi per tutte le fasi!
                </p>
                <p style="color: #e74c3c; margin: 5px 0 0 0; font-size: 0.9em;">
                    Chi non agisce in tempo perde il turno
                </p>
            </div>
            <button onclick="loadGameStatus()" class="btn" style="background: #3498db; color: white; border: none; padding: 12px 24px; border-radius: 8px; cursor: pointer; font-weight: bold;">
                üîÑ Aggiorna Stato
            </button>
        </div>
    `;
}

// AZIONI RAPIDE CON CONTROLLO AUTOMATICO

// AZIONE NOTTURNA
function submitAction() {
    if (!selectedTarget) return;

    const btn = document.getElementById('action-btn');
    btn.disabled = true;
    btn.textContent = 'Inviando...';

    fetch('/api/lupus-action', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({
            action_type: getActionType(),
            target_id: selectedTarget
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showResult('‚úÖ Azione inviata! Controllo avanzamento...', 'success');

            // Controllo immediato per avanzamento automatico
            setTimeout(() => {
                checkAutoAdvancement();
                loadGameStatus();
            }, 500);

        } else {
            showResult(`‚ùå ${data.error}`, 'error');
            btn.disabled = false;
            btn.textContent = getActionButtonText();
        }
    })
    .catch(error => {
        showResult('üîå Errore di connessione', 'error');
        btn.disabled = false;
        btn.textContent = getActionButtonText();
    });
}

// VOTAZIONE
function submitVote() {
    if (!selectedTarget) return;

    const btn = document.getElementById('action-btn');
    btn.disabled = true;
    btn.textContent = 'Votando...';

    fetch('/api/lupus-vote', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({
            target_id: selectedTarget
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            const voteWeight = data.peso_voto > 1 ? ` (voto doppio!)` : '';
            showResult(`üó≥Ô∏è Voto registrato!${voteWeight} Controllo avanzamento...`, 'success');

            // Controllo immediato per avanzamento automatico
            setTimeout(() => {
                checkAutoAdvancement();
                loadGameStatus();
            }, 500);

        } else {
            showResult(`‚ùå ${data.error}`, 'error');
            btn.disabled = false;
            btn.textContent = 'Vota Giocatore';
        }
    })
    .catch(error => {
        showResult('üîå Errore di connessione', 'error');
        btn.disabled = false;
        btn.textContent = 'Vota Giocatore';
    });
}

// FUNZIONI UTILITY

function selectTarget(playerId) {
    selectedTarget = playerId;

    // Rimuovi selezione precedente
    document.querySelectorAll('.player-card').forEach(card => {
        card.classList.remove('selected');
    });

    // Aggiungi selezione corrente
    event.currentTarget.classList.add('selected');

    // Abilita bottone
    const btn = document.getElementById('action-btn');
    if (btn) {
        btn.disabled = false;
    }
}

function getActionType() {
    if (!gameData) return 'unknown';

    const ruolo = gameData.ruolo;
    if (ruolo.team === 'lupi') return 'kill';
    if (ruolo.nome === 'Veggente') return 'investigate';
    if (ruolo.nome === 'Guardia') return 'protect';

    return 'unknown';
}

function getActionButtonText() {
    if (!gameData) return 'Conferma Azione';

    const phase = gameData.fase_corrente;
    const ruolo = gameData.ruolo;

    if (phase === 'night') {
        if (ruolo.team === 'lupi') return 'Elimina Giocatore';
        if (ruolo.nome === 'Veggente') return 'Investiga Giocatore';
        if (ruolo.nome === 'Guardia') return 'Proteggi Giocatore';
    } else if (phase === 'voting') {
        return 'Vota Giocatore';
    }

    return 'Conferma Azione';
}

function showResult(message, type) {
    const resultDiv = document.getElementById('result-messages');
    const messageElement = document.createElement('div');
    messageElement.className = `result-message result-${type}`;
    messageElement.textContent = message;

    resultDiv.appendChild(messageElement);

    // Rimuovi dopo 5 secondi
    setTimeout(() => {
        if (resultDiv.contains(messageElement)) {
            resultDiv.removeChild(messageElement);
        }
    }, 5000);
}

function showError(message) {
    showResult(message, 'error');
}

function notifyPhaseChange(newPhase) {
    const phaseMessages = {
        'night': 'üåô √à calata la notte... I lupi si svegliano!',
        'day': '‚òÄÔ∏è √à sorto il sole! Tempo di discutere!',
        'voting': 'üó≥Ô∏è Tempo di votare! Chi volete eliminare?',
        'setup': '‚öôÔ∏è Preparazione in corso...'
    };

    if (phaseMessages[newPhase]) {
        showResult(phaseMessages[newPhase], 'info');
    }
}

function updateEventsList(eventi) {
    const eventsList = document.getElementById('events-list');
    if (!eventsList || !eventi) return;

    eventsList.innerHTML = eventi.slice(0, 5).map(evento => `
        <div class="event-item">
            <span class="event-time">T${evento.turno}</span>
            <span class="event-description">${evento.descrizione}</span>
        </div>
    `).join('');
}

// INTERFACCE SPECIALI

function showDeadPlayerInterface(stato) {
    const gameArea = document.getElementById('game-area');

    let message = '';
    let emoji = '';

    if (stato === 'morto') {
        message = 'Sei stato eliminato dai lupi! üíÄ';
        emoji = 'üåô';
    } else if (stato === 'eliminato') {
        message = 'Sei stato eliminato dalla votazione! ‚öñÔ∏è';
        emoji = 'üó≥Ô∏è';
    }

    gameArea.innerHTML = `
        <div style="text-align: center; padding: 40px;">
            <div style="font-size: 4em; margin-bottom: 20px;">${emoji}</div>
            <h2 style="color: #e74c3c; margin-bottom: 20px;">${message}</h2>
            <p style="font-size: 1.2em; opacity: 0.8;">Puoi continuare a seguire la partita, ma non puoi pi√π partecipare.</p>
        </div>
    `;
}

function showGameEndedInterface(data) {
    const gameArea = document.getElementById('game-area');

    gameArea.innerHTML = `
        <div style="text-align: center; padding: 40px;">
            <div style="font-size: 4em; margin-bottom: 20px;">üèÜ</div>
            <h2 style="color: #27ae60; margin-bottom: 20px;">Partita Terminata!</h2>
            <p style="font-size: 1.4em; margin-bottom: 20px;">Vincitori: <strong>${data.vincitori}</strong></p>
            <button onclick="window.location.href='/dashboard'" class="btn" style="background: #3498db; color: white; border: none; padding: 15px 30px; border-radius: 10px; font-size: 1.1em; cursor: pointer;">
                üè† Torna alla Dashboard
            </button>
        </div>
    `;
}

function showWaitingForPlayersInterface(data) {
    const actionsSection = document.getElementById('actions-section');
    actionsSection.style.display = 'block';

    actionsSection.innerHTML = `
        <div style="text-align: center; padding: 30px; background: rgba(155, 89, 182, 0.1); border-radius: 15px; border: 2px solid #9b59b6;">
            <h3 style="color: #9b59b6; margin-bottom: 15px;">‚öôÔ∏è Preparazione Partita</h3>
            <p style="font-size: 1.1em; margin-bottom: 20px;">
                In attesa che il gamemaster avvii la partita...
            </p>
            <div style="background: rgba(52, 152, 219, 0.1); padding: 15px; border-radius: 10px;">
                <p style="margin: 0; font-weight: bold;">
                    Giocatori pronti: ${data.totale_giocatori || 0}
                </p>
            </div>
        </div>
    `;
}

// GESTIONE REFRESH E CLEANUP

function refreshGame() {
    loadGameStatus();
    showResult('Gioco aggiornato!', 'success');
}

// Gestione visibilit√† pagina
document.addEventListener('visibilitychange', function() {
    if (document.hidden) {
        if (refreshInterval) {
            clearInterval(refreshInterval);
        }
    } else {
        startPeriodicUpdates();
        loadGameStatus();
    }
});

// Cleanup quando si lascia la pagina
window.addEventListener('beforeunload', function() {
    if (refreshInterval) {
        clearInterval(refreshInterval);
    }
});

// Gestione tasti rapidi
document.addEventListener('keydown', function(e) {
    // F5 per refresh
    if (e.key === 'F5') {
        e.preventDefault();
        refreshGame();
    }

    // Spazio per confermare azione
    if (e.code === 'Space' && selectedTarget) {
        const btn = document.getElementById('action-btn');
        if (btn && !btn.disabled) {
            e.preventDefault();
            if (gameData.fase_corrente === 'voting') {
                submitVote();
            } else {
                submitAction();
            }
        }
    }
});</script>
</body>
</html>