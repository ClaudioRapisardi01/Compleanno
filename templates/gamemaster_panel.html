<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>🎮 Pannello Gamemaster - Birthday Game</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #2c3e50 0%, #3498db 100%);
            min-height: 100vh;
            color: white;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
        }

        .header {
            text-align: center;
            margin-bottom: 40px;
        }

        .header h1 {
            font-size: 3em;
            margin-bottom: 10px;
            background: linear-gradient(45deg, #ffd700, #ffed4a);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .tabs {
            display: flex;
            justify-content: center;
            margin-bottom: 30px;
            gap: 10px;
            flex-wrap: wrap;
        }

        .tab-btn {
            background: rgba(255, 255, 255, 0.1);
            border: 2px solid rgba(255, 255, 255, 0.3);
            color: white;
            padding: 15px 25px;
            border-radius: 25px;
            cursor: pointer;
            transition: all 0.3s ease;
            font-weight: bold;
        }

        .tab-btn.active {
            background: linear-gradient(45deg, #ffd700, #ffed4a);
            color: #333;
            border-color: #ffd700;
        }

        .tab-content {
            display: none;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 20px;
            padding: 30px;
            backdrop-filter: blur(10px);
        }

        .tab-content.active {
            display: block;
        }

        .section-title {
            font-size: 2em;
            margin-bottom: 20px;
            color: #ffd700;
            text-align: center;
        }

        .controls-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 25px;
            margin-bottom: 30px;
        }

        .control-card {
            background: rgba(255, 255, 255, 0.15);
            border-radius: 15px;
            padding: 25px;
            border: 2px solid rgba(255, 255, 255, 0.2);
        }

        .control-card h3 {
            color: #ffd700;
            margin-bottom: 15px;
            font-size: 1.3em;
        }

        .btn {
            background: linear-gradient(45deg, #27ae60, #2ecc71);
            color: white;
            border: none;
            padding: 12px 25px;
            border-radius: 25px;
            cursor: pointer;
            font-weight: bold;
            transition: all 0.3s ease;
            margin: 5px;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(39, 174, 96, 0.4);
        }

        .btn-danger {
            background: linear-gradient(45deg, #e74c3c, #c0392b);
        }

        .btn-danger:hover {
            box-shadow: 0 5px 15px rgba(231, 76, 60, 0.4);
        }

        .btn-warning {
            background: linear-gradient(45deg, #f39c12, #e67e22);
        }

        .btn-warning:hover {
            box-shadow: 0 5px 15px rgba(243, 156, 18, 0.4);
        }

        .btn-secondary {
            background: linear-gradient(45deg, #95a5a6, #7f8c8d);
        }

        .btn-secondary:hover {
            box-shadow: 0 5px 15px rgba(149, 165, 166, 0.4);
        }

        .input-group {
            margin-bottom: 15px;
        }

        .input-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
        }

        .input-group input,
        .input-group select,
        .input-group textarea {
            width: 100%;
            padding: 10px;
            border: 2px solid rgba(255, 255, 255, 0.3);
            border-radius: 10px;
            background: rgba(255, 255, 255, 0.1);
            color: white;
            font-size: 1em;
        }

        .input-group input::placeholder,
        .input-group textarea::placeholder {
            color: rgba(255, 255, 255, 0.7);
        }

        .players-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }

        .player-card {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 15px;
            padding: 20px;
            border: 2px solid rgba(255, 255, 255, 0.2);
            transition: all 0.3s ease;
        }

        .player-card:hover {
            transform: translateY(-5px);
            border-color: #ffd700;
        }

        .player-header {
            display: flex;
            align-items: center;
            margin-bottom: 15px;
        }

        .player-avatar {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            background: linear-gradient(45deg, #667eea, #764ba2);
            display: flex;
            align-items: center;
            justify-content: center;
            margin-right: 15px;
            overflow: hidden;
        }

        .player-avatar img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .player-info h4 {
            color: #ffd700;
            margin-bottom: 5px;
        }

        .player-stats {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 10px;
            margin: 15px 0;
        }

        .stat {
            text-align: center;
            background: rgba(255, 255, 255, 0.1);
            padding: 10px;
            border-radius: 10px;
        }

        .stat-value {
            font-size: 1.5em;
            font-weight: bold;
            color: #ffd700;
        }

        .stat-label {
            font-size: 0.8em;
            opacity: 0.8;
        }

        .questions-list {
            max-height: 400px;
            overflow-y: auto;
            margin-top: 20px;
        }

        .question-item {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 10px;
            padding: 15px;
            margin-bottom: 15px;
            border: 2px solid rgba(255, 255, 255, 0.2);
        }

        .question-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }

        .question-text {
            font-weight: bold;
            margin-bottom: 10px;
        }

        .question-options {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 10px;
            margin-bottom: 10px;
        }

        .option {
            background: rgba(255, 255, 255, 0.1);
            padding: 8px;
            border-radius: 5px;
            font-size: 0.9em;
        }

        .option.correct {
            background: rgba(39, 174, 96, 0.3);
            border: 2px solid #27ae60;
        }

        .people-list {
            max-height: 400px;
            overflow-y: auto;
            margin-top: 20px;
        }

        .person-item {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 10px;
            padding: 15px;
            margin-bottom: 15px;
            border: 2px solid rgba(255, 255, 255, 0.2);
        }

        .person-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }

        .clues-list {
            margin-top: 10px;
        }

        .clue-item {
            background: rgba(255, 255, 255, 0.1);
            padding: 10px;
            border-radius: 5px;
            margin-bottom: 5px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        /* Stili specifici per Votazione Costumi */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 15px;
            margin: 20px 0;
        }

        .stat-card {
            background: rgba(255, 255, 255, 0.1);
            padding: 15px;
            border-radius: 10px;
            text-align: center;
            border: 2px solid rgba(255, 255, 255, 0.2);
            transition: all 0.3s ease;
        }

        .stat-card:hover {
            border-color: #ffd700;
            transform: translateY(-2px);
        }

        .stat-card .value {
            font-size: 2em;
            font-weight: bold;
            margin-bottom: 5px;
        }

        .stat-card .label {
            font-size: 0.9em;
            opacity: 0.8;
        }

        .results-container {
            max-height: 400px;
            overflow-y: auto;
            margin-top: 20px;
        }

        .result-item {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 10px;
            padding: 15px;
            margin-bottom: 10px;
            display: flex;
            align-items: center;
            transition: all 0.3s ease;
        }

        .result-item:hover {
            background: rgba(255, 255, 255, 0.2);
            transform: translateX(5px);
        }

        .result-position {
            font-size: 1.5em;
            font-weight: bold;
            margin-right: 15px;
            min-width: 40px;
            text-align: center;
        }

        .result-position.first { color: #ffd700; }
        .result-position.second { color: #c0c0c0; }
        .result-position.third { color: #cd7f32; }

        .result-avatar {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            background: linear-gradient(45deg, #667eea, #764ba2);
            display: flex;
            align-items: center;
            justify-content: center;
            margin-right: 15px;
            overflow: hidden;
        }

        .result-avatar img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .result-info {
            flex: 1;
        }

        .result-name {
            font-weight: bold;
            font-size: 1.1em;
            margin-bottom: 5px;
        }

        .result-details {
            font-size: 0.9em;
            opacity: 0.8;
        }

        .result-score {
            text-align: right;
        }

        .result-points {
            font-size: 1.3em;
            font-weight: bold;
            color: #ffd700;
        }

        .result-breakdown {
            font-size: 0.8em;
            opacity: 0.8;
        }

        .voters-list {
            max-height: 300px;
            overflow-y: auto;
        }

        .voter-item {
            background: rgba(255, 255, 255, 0.1);
            padding: 10px;
            border-radius: 8px;
            margin-bottom: 8px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .category-analysis-item {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 10px;
            padding: 20px;
            text-align: center;
        }

        .category-title {
            font-size: 1.2em;
            font-weight: bold;
            margin-bottom: 15px;
            color: #ffd700;
        }

        .category-stats {
            font-size: 0.9em;
            opacity: 0.9;
        }

        .notification {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 15px 20px;
            border-radius: 10px;
            color: white;
            font-weight: bold;
            z-index: 1000;
            transform: translateX(400px);
            transition: transform 0.4s ease;
        }

        .notification.success {
            background: linear-gradient(45deg, #27ae60, #2ecc71);
        }

        .notification.error {
            background: linear-gradient(45deg, #e74c3c, #c0392b);
        }

        .notification.show {
            transform: translateX(0);
        }

        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.5);
        }

        .modal-content {
            background: linear-gradient(135deg, #2c3e50 0%, #3498db 100%);
            margin: 5% auto;
            padding: 30px;
            border-radius: 20px;
            width: 90%;
            max-width: 500px;
            color: white;
        }

        .close {
            color: #aaa;
            float: right;
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
        }

        .close:hover {
            color: white;
        }

        @media (max-width: 768px) {
            .container {
                padding: 10px;
            }

            .controls-grid {
                grid-template-columns: 1fr;
            }

            .players-grid {
                grid-template-columns: 1fr;
            }

            .tabs {
                flex-direction: column;
            }

            .stats-grid {
                grid-template-columns: repeat(2, 1fr);
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>🎮 Pannello Gamemaster</h1>
            <p>Controlla tutti gli aspetti della festa</p>
        </div>

        <div class="tabs">
            <button class="tab-btn active" onclick="switchTab('overview')">📊 Panoramica</button>
            <button class="tab-btn" onclick="switchTab('quiz')">🧠 Quiz</button>
            <button class="tab-btn" onclick="switchTab('indovina')">🕵️ Indovina Chi</button>
            <button class="tab-btn" onclick="switchTab('votazione')">🏆 Votazione</button>
            <button class="tab-btn" onclick="switchTab('players')">👥 Giocatori</button>
        </div>

        <!-- Tab Panoramica -->
        <div id="overview-tab" class="tab-content active">
            <h2 class="section-title">📊 Controllo Giochi</h2>

            <div class="controls-grid">
                <div class="control-card">
                    <h3>🎮 Stato Gioco Attuale</h3>
                    <p id="current-game-status">Nessun gioco attivo</p>
                    <div style="margin-top: 15px;">
                        <button class="btn btn-danger" onclick="stopAllGames()">⏹️ Ferma Tutti i Giochi</button>
                    </div>
                </div>

                <div class="control-card">
                    <h3>🧠 Quiz Personalizzato</h3>
                    <p>Domande caricate: <span id="quiz-questions-count">0</span></p>
                    <div style="margin-top: 15px;">
                        <button class="btn" onclick="startGame('quiz_personalizzato')">▶️ Avvia Quiz</button>
                        <button class="btn btn-warning" onclick="stopGame('quiz_personalizzato')">⏸️ Ferma Quiz</button>
                    </div>
                </div>

                <div class="control-card">
                    <h3>🕵️ Indovina Chi</h3>
                    <p>Persone configurate: <span id="indovina-people-count">0</span></p>
                    <div style="margin-top: 15px;">
                        <button class="btn" onclick="startGame('indovina_chi')">▶️ Avvia Indovina Chi</button>
                        <button class="btn btn-warning" onclick="stopGame('indovina_chi')">⏸️ Ferma Indovina Chi</button>
                    </div>
                </div>

                <div class="control-card">
                    <h3>🏆 Votazione Costumi</h3>
                    <p>Sistema di votazione per i migliori costumi</p>
                    <div style="margin-top: 15px;">
                        <button class="btn" onclick="startGame('votazione_costumi')">▶️ Avvia Votazione</button>
                        <button class="btn btn-warning" onclick="stopGame('votazione_costumi')">⏸️ Ferma Votazione</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Tab Quiz -->
        <div id="quiz-tab" class="tab-content">
            <h2 class="section-title">🧠 Gestione Quiz</h2>

            <div class="control-card">
                <h3>➕ Aggiungi Nuova Domanda</h3>
                <form id="quiz-form">
                    <div class="input-group">
                        <label>Domanda:</label>
                        <textarea id="quiz-question" placeholder="Inserisci la domanda..." rows="3"></textarea>
                    </div>
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                        <div class="input-group">
                            <label>Opzione A:</label>
                            <input type="text" id="quiz-option-a" placeholder="Prima opzione">
                        </div>
                        <div class="input-group">
                            <label>Opzione B:</label>
                            <input type="text" id="quiz-option-b" placeholder="Seconda opzione">
                        </div>
                        <div class="input-group">
                            <label>Opzione C:</label>
                            <input type="text" id="quiz-option-c" placeholder="Terza opzione">
                        </div>
                        <div class="input-group">
                            <label>Opzione D:</label>
                            <input type="text" id="quiz-option-d" placeholder="Quarta opzione">
                        </div>
                    </div>
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                        <div class="input-group">
                            <label>Risposta Corretta:</label>
                            <select id="quiz-correct">
                                <option value="a">A</option>
                                <option value="b">B</option>
                                <option value="c">C</option>
                                <option value="d">D</option>
                            </select>
                        </div>
                        <div class="input-group">
                            <label>Categoria:</label>
                            <input type="text" id="quiz-category" placeholder="generale" value="generale">
                        </div>
                    </div>
                    <button type="submit" class="btn">✅ Aggiungi Domanda</button>
                </form>
            </div>

            <div class="questions-list" id="questions-list">
                <!-- Le domande verranno caricate qui -->
            </div>
        </div>

        <!-- Tab Indovina Chi -->
        <div id="indovina-tab" class="tab-content">
            <h2 class="section-title">🕵️ Gestione Indovina Chi</h2>

            <div class="control-card">
                <h3>👤 Aggiungi Nuova Persona</h3>
                <form id="person-form">
                    <div class="input-group">
                        <label>Nome:</label>
                        <input type="text" id="person-name" placeholder="Nome della persona">
                    </div>
                    <div class="input-group">
                        <label>Descrizione:</label>
                        <textarea id="person-description" placeholder="Breve descrizione..." rows="2"></textarea>
                    </div>
                    <button type="submit" class="btn">✅ Aggiungi Persona</button>
                </form>
            </div>

            <div class="people-list" id="people-list">
                <!-- Le persone verranno caricate qui -->
            </div>
        </div>

        <!-- Tab Votazione Costumi -->
        <div id="votazione-tab" class="tab-content">
            <h2 class="section-title">🏆 Gestione Votazione Costumi</h2>

            <!-- Statistiche Generali -->
            <div class="control-card">
                <h3>📊 Statistiche Votazione</h3>
                <div class="stats-grid">
                    <div class="stat-card">
                        <div class="value" style="color: #27ae60;" id="total-voters">0</div>
                        <div class="label">Votanti</div>
                    </div>
                    <div class="stat-card">
                        <div class="value" style="color: #3498db;" id="total-votes">0</div>
                        <div class="label">Voti Totali</div>
                    </div>
                    <div class="stat-card">
                        <div class="value" style="color: #f39c12;" id="voted-contestants">0</div>
                        <div class="label">Candidati Votati</div>
                    </div>
                    <div class="stat-card">
                        <div class="value" style="color: #e74c3c;" id="non-voters-count">0</div>
                        <div class="label">Non Votanti</div>
                    </div>
                </div>

                <div style="margin-top: 20px;">
                    <button class="btn" onclick="loadVotazioneStats()">🔄 Aggiorna Statistiche</button>
                    <button class="btn btn-warning" onclick="resetVotazione()">🗑️ Reset Votazione</button>
                    <button class="btn btn-secondary" onclick="exportVotazioneResults()">📊 Esporta Risultati</button>
                </div>
            </div>

            <!-- Risultati Live -->
            <div class="control-card">
                <h3>🏅 Risultati Live</h3>
                <div id="live-results-container" class="results-container">
                    <!-- I risultati verranno caricati qui -->
                </div>
            </div>

            <!-- Chi Ha Votato / Non Ha Votato -->
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 25px; margin-top: 25px;">
                <div class="control-card">
                    <h3>✅ Hanno Votato (<span id="voters-count">0</span>)</h3>
                    <div id="voters-list" class="voters-list">
                        <!-- Lista votanti -->
                    </div>
                </div>

                <div class="control-card">
                    <h3>⏳ Non Hanno Votato (<span id="non-voters-list-count">0</span>)</h3>
                    <div id="non-voters-list" class="voters-list">
                        <!-- Lista non votanti -->
                    </div>
                </div>
            </div>

            <!-- Analisi per Posizione -->
            <div class="control-card">
                <h3>🎯 Analisi per Posizione</h3>
                <div id="category-analysis" style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 20px; margin-top: 20px;">
                    <!-- Analisi per categoria verranno caricate qui -->
                </div>
            </div>
        </div>

        <!-- Tab Giocatori -->
        <div id="players-tab" class="tab-content">
            <h2 class="section-title">👥 Gestione Giocatori</h2>

            <div style="margin-bottom: 20px; text-align: center;">
                <button class="btn" onclick="loadPlayers()">🔄 Aggiorna Lista</button>
                <button class="btn btn-warning" onclick="resetAllScores()">🔄 Reset Punteggi</button>
            </div>

            <div class="players-grid" id="players-grid">
                <!-- I giocatori verranno caricati qui -->
            </div>
        </div>
    </div>

    <!-- Modal per aggiungere indizi -->
    <div id="clues-modal" class="modal">
        <div class="modal-content">
            <span class="close">&times;</span>
            <h3 id="modal-person-name">Gestione Indizi</h3>
            <form id="clue-form">
                <input type="hidden" id="clue-person-id">
                <div class="input-group">
                    <label>Indizio:</label>
                    <textarea id="clue-text" placeholder="Inserisci l'indizio..." rows="2"></textarea>
                </div>
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                    <div class="input-group">
                        <label>Ordine:</label>
                        <input type="number" id="clue-order" min="1" value="1">
                    </div>
                    <div class="input-group">
                        <label>Punti:</label>
                        <input type="number" id="clue-points" min="0" value="50">
                    </div>
                </div>
                <button type="submit" class="btn">✅ Aggiungi Indizio</button>
            </form>
            <div id="clues-list-modal" style="margin-top: 20px;">
                <!-- Gli indizi verranno caricati qui -->
            </div>
        </div>
    </div>

    <script>
        let currentTab = 'overview';
        let quizQuestions = [];
        let indovinaPeople = [];
        let players = [];
        let votazioneStats = {};

        // Inizializzazione
        document.addEventListener('DOMContentLoaded', function() {
            loadGameStatus();
            loadQuizQuestions();
            loadIndovinaPeople();
            loadPlayers();

            // Setup form handlers
            document.getElementById('quiz-form').addEventListener('submit', handleQuizSubmit);
            document.getElementById('person-form').addEventListener('submit', handlePersonSubmit);
            document.getElementById('clue-form').addEventListener('submit', handleClueSubmit);

            // Setup modal
            setupModal();

            // Auto-refresh ogni 30 secondi
            setInterval(loadGameStatus, 30000);
        });

        // Gestione tabs
        function switchTab(tabName) {
            // Nascondi tutti i tab
            document.querySelectorAll('.tab-content').forEach(tab => {
                tab.classList.remove('active');
            });

            // Rimuovi active da tutti i bottoni
            document.querySelectorAll('.tab-btn').forEach(btn => {
                btn.classList.remove('active');
            });

            // Mostra il tab selezionato
            document.getElementById(tabName + '-tab').classList.add('active');
            event.target.classList.add('active');

            currentTab = tabName;

            // Carica dati specifici per il tab
            if (tabName === 'votazione') {
                loadVotazioneStats();
            }
        }

        // Carica stato gioco
        function loadGameStatus() {
            fetch('/api/game-status')
                .then(response => response.json())
                .then(data => {
                    const statusElement = document.getElementById('current-game-status');
                    if (data.gioco_attivo) {
                        statusElement.textContent = `Attivo: ${data.gioco_attivo}`;
                        statusElement.style.color = '#27ae60';
                    } else {
                        statusElement.textContent = 'Nessun gioco attivo';
                        statusElement.style.color = '#e74c3c';
                    }
                })
                .catch(error => {
                    console.error('Errore caricamento stato gioco:', error);
                });
        }

        // Gestione giochi
        function startGame(gameType) {
            if (!confirm(`Sei sicuro di voler avviare ${gameType.replace('_', ' ')}?`)) return;

            const messages = {
                'quiz_personalizzato': 'Quiz Personalizzato avviato! 🧠 Rispondi alle domande!',
                'indovina_chi': 'Indovina Chi avviato! 🕵️ Scopri chi si nasconde!',
                'votazione_costumi': 'Votazione Costumi avviata! 🏆 Vota i migliori!'
            };

            const requestData = {
                gioco_attivo: gameType,
                messaggio: messages[gameType] || 'Gioco avviato!'
            };

            fetch('/api/gamemaster/game-state', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(requestData)
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    showNotification(`${gameType.replace('_', ' ')} avviato con successo!`, 'success');
                    loadGameStatus();
                } else {
                    showNotification(data.error || 'Errore avvio gioco', 'error');
                }
            })
            .catch(error => {
                showNotification(`Errore avvio gioco: ${error.message}`, 'error');
            });
        }

        function stopGame(gameType) {
            if (!confirm(`Sei sicuro di voler fermare ${gameType.replace('_', ' ')}?`)) return;

            fetch('/api/gamemaster/game-state', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    gioco_attivo: null,
                    messaggio: 'Gioco terminato. In attesa del prossimo gioco...'
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    showNotification('Gioco fermato con successo', 'success');
                    loadGameStatus();
                } else {
                    showNotification(data.error || 'Errore stop gioco', 'error');
                }
            })
            .catch(error => {
                showNotification(`Errore stop gioco: ${error.message}`, 'error');
            });
        }

        function stopAllGames() {
            if (!confirm('Sei sicuro di voler fermare tutti i giochi?')) return;

            fetch('/api/gamemaster/game-state', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    gioco_attivo: null,
                    messaggio: 'Tutti i giochi sono stati fermati. In attesa del gamemaster...'
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    showNotification('Tutti i giochi fermati', 'success');
                    loadGameStatus();
                } else {
                    showNotification(data.error || 'Errore', 'error');
                }
            })
            .catch(error => {
                showNotification(`Errore: ${error.message}`, 'error');
            });
        }

        // === FUNZIONI QUIZ ===
        function loadQuizQuestions() {
            fetch('/api/gamemaster/quiz-questions')
                .then(response => response.json())
                .then(data => {
                    quizQuestions = data;
                    updateQuizDisplay();
                })
                .catch(error => {
                    console.error('Errore caricamento domande:', error);
                });
        }

        function updateQuizDisplay() {
            document.getElementById('quiz-questions-count').textContent = quizQuestions.length;

            const container = document.getElementById('questions-list');
            if (quizQuestions.length === 0) {
                container.innerHTML = '<p style="text-align: center; opacity: 0.7;">Nessuna domanda configurata</p>';
                return;
            }

            let html = '';
            quizQuestions.forEach(question => {
                html += `
                    <div class="question-item">
                        <div class="question-header">
                            <span style="color: #ffd700; font-size: 0.9em;">${question.categoria}</span>
                            <button class="btn btn-danger" onclick="deleteQuestion(${question.id})" style="padding: 5px 10px; font-size: 0.8em;">🗑️ Elimina</button>
                        </div>
                        <div class="question-text">${question.domanda}</div>
                        <div class="question-options">
                            <div class="option ${question.risposta_corretta === 'a' ? 'correct' : ''}">A) ${question.opzione_a}</div>
                            <div class="option ${question.risposta_corretta === 'b' ? 'correct' : ''}">B) ${question.opzione_b}</div>
                            <div class="option ${question.risposta_corretta === 'c' ? 'correct' : ''}">C) ${question.opzione_c}</div>
                            <div class="option ${question.risposta_corretta === 'd' ? 'correct' : ''}">D) ${question.opzione_d}</div>
                        </div>
                    </div>
                `;
            });
            container.innerHTML = html;
        }

        function handleQuizSubmit(event) {
            event.preventDefault();

            const formData = {
                domanda: document.getElementById('quiz-question').value.trim(),
                opzione_a: document.getElementById('quiz-option-a').value.trim(),
                opzione_b: document.getElementById('quiz-option-b').value.trim(),
                opzione_c: document.getElementById('quiz-option-c').value.trim(),
                opzione_d: document.getElementById('quiz-option-d').value.trim(),
                risposta_corretta: document.getElementById('quiz-correct').value,
                categoria: document.getElementById('quiz-category').value.trim() || 'generale'
            };

            if (!formData.domanda || !formData.opzione_a || !formData.opzione_b || !formData.opzione_c || !formData.opzione_d) {
                showNotification('Tutti i campi sono obbligatori', 'error');
                return;
            }

            fetch('/api/gamemaster/quiz-questions', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(formData)
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    showNotification('Domanda aggiunta!', 'success');
                    document.getElementById('quiz-form').reset();
                    document.getElementById('quiz-category').value = 'generale';
                    loadQuizQuestions();
                } else {
                    showNotification(data.error || 'Errore aggiunta domanda', 'error');
                }
            })
            .catch(error => {
                showNotification('Errore aggiunta domanda', 'error');
            });
        }

        function deleteQuestion(questionId) {
            if (!confirm('Sei sicuro di voler eliminare questa domanda?')) return;

            fetch(`/api/gamemaster/quiz-questions/${questionId}`, {
                method: 'DELETE'
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    showNotification('Domanda eliminata', 'success');
                    loadQuizQuestions();
                } else {
                    showNotification('Errore eliminazione', 'error');
                }
            })
            .catch(error => {
                showNotification('Errore eliminazione', 'error');
            });
        }

        // === FUNZIONI INDOVINA CHI ===
        function loadIndovinaPeople() {
            fetch('/api/gamemaster/indovina-people')
                .then(response => response.json())
                .then(data => {
                    indovinaPeople = data;
                    updateIndovinaDisplay();
                })
                .catch(error => {
                    console.error('Errore caricamento persone:', error);
                });
        }

        function updateIndovinaDisplay() {
            document.getElementById('indovina-people-count').textContent = indovinaPeople.length;

            const container = document.getElementById('people-list');
            if (indovinaPeople.length === 0) {
                container.innerHTML = '<p style="text-align: center; opacity: 0.7;">Nessuna persona configurata</p>';
                return;
            }

            let html = '';
            indovinaPeople.forEach(person => {
                html += `
                    <div class="person-item">
                        <div class="person-header">
                            <div>
                                <h4>${person.nome}</h4>
                                <p style="opacity: 0.8; margin: 5px 0;">${person.descrizione || 'Nessuna descrizione'}</p>
                            </div>
                            <div>
                                <button class="btn" onclick="manageClues(${person.id}, '${person.nome}')" style="padding: 8px 15px; font-size: 0.9em;">🔧 Gestisci Indizi</button>
                            </div>
                        </div>
                    </div>
                `;
            });
            container.innerHTML = html;
        }

        function handlePersonSubmit(event) {
            event.preventDefault();

            const formData = {
                nome: document.getElementById('person-name').value.trim(),
                descrizione: document.getElementById('person-description').value.trim()
            };

            if (!formData.nome) {
                showNotification('Il nome è obbligatorio', 'error');
                return;
            }

            fetch('/api/gamemaster/indovina-people', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(formData)
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    showNotification('Persona aggiunta!', 'success');
                    document.getElementById('person-form').reset();
                    loadIndovinaPeople();
                } else {
                    showNotification(data.error || 'Errore aggiunta persona', 'error');
                }
            })
            .catch(error => {
                showNotification('Errore aggiunta persona', 'error');
            });
        }

        // === FUNZIONI VOTAZIONE COSTUMI ===
        function loadVotazioneStats() {
            fetch('/api/gamemaster/votazione-costumi/stats')
                .then(response => response.json())
                .then(data => {
                    if (data.error) {
                        showNotification('Errore caricamento statistiche: ' + data.error, 'error');
                        return;
                    }

                    votazioneStats = data;
                    updateVotazioneDisplay(data);
                })
                .catch(error => {
                    console.error('Errore caricamento statistiche votazione:', error);
                    showNotification('Errore di connessione', 'error');
                });

            // Carica anche i risultati live
            loadVotazioneResults();
        }

        function updateVotazioneDisplay(data) {
            // Aggiorna statistiche generali
            document.getElementById('total-voters').textContent = data.general_stats.total_voters;
            document.getElementById('total-votes').textContent = data.general_stats.total_votes;
            document.getElementById('voted-contestants').textContent = data.general_stats.voted_contestants;
            document.getElementById('non-voters-count').textContent = data.non_voters.length;

            // Aggiorna contatori nelle sezioni
            document.getElementById('voters-count').textContent = data.voters.length;
            document.getElementById('non-voters-list-count').textContent = data.non_voters.length;

            // Aggiorna lista votanti
            const votersList = document.getElementById('voters-list');
            if (data.voters.length === 0) {
                votersList.innerHTML = '<div style="text-align: center; opacity: 0.7; padding: 20px;">Nessuno ha ancora votato</div>';
            } else {
                let votersHtml = '';
                data.voters.forEach(voter => {
                    votersHtml += `
                        <div class="voter-item">
                            <span>${voter.nome}</span>
                            <span style="font-size: 0.9em; opacity: 0.8;">Squadra ${voter.squadra}</span>
                        </div>
                    `;
                });
                votersList.innerHTML = votersHtml;
            }

            // Aggiorna lista non votanti
            const nonVotersList = document.getElementById('non-voters-list');
            if (data.non_voters.length === 0) {
                nonVotersList.innerHTML = '<div style="text-align: center; opacity: 0.7; padding: 20px;">Tutti hanno votato! 🎉</div>';
            } else {
                let nonVotersHtml = '';
                data.non_voters.forEach(nonVoter => {
                    nonVotersHtml += `
                        <div class="voter-item">
                            <span>${nonVoter.nome}</span>
                            <span style="font-size: 0.9em; opacity: 0.8;">Squadra ${nonVoter.squadra}</span>
                        </div>
                    `;
                });
                nonVotersList.innerHTML = nonVotersHtml;
            }

            // Aggiorna analisi per categoria
            const categoryAnalysis = document.getElementById('category-analysis');
            const categories = ['primo_posto', 'secondo_posto', 'terzo_posto'];
            const categoryLabels = ['🥇 Primo Posto', '🥈 Secondo Posto', '🥉 Terzo Posto'];

            let categoryHtml = '';
            categories.forEach((category, index) => {
                const categoryData = data.top_by_category[category] || [];
                const topContestant = categoryData[0] || { nome: 'Nessuno', votes: 0 };

                categoryHtml += `
                    <div class="category-analysis-item">
                        <div class="category-title">${categoryLabels[index]}</div>
                        <div style="font-size: 1.5em; font-weight: bold; margin: 10px 0;">${topContestant.nome}</div>
                        <div class="category-stats">${topContestant.votes} voti</div>
                    </div>
                `;
            });
            categoryAnalysis.innerHTML = categoryHtml;
        }

        function loadVotazioneResults() {
            fetch('/api/votazione-costumi/results')
                .then(response => response.json())
                .then(data => {
                    if (data.error) {
                        console.error('Errore caricamento risultati:', data.error);
                        return;
                    }

                    displayVotazioneResults(data.results);
                })
                .catch(error => {
                    console.error('Errore caricamento risultati votazione:', error);
                });
        }

        function displayVotazioneResults(results) {
            const container = document.getElementById('live-results-container');

            if (results.length === 0) {
                container.innerHTML = '<div style="text-align: center; opacity: 0.7; padding: 40px;">Nessun risultato ancora disponibile</div>';
                return;
            }

            let html = '';
            results.forEach((result, index) => {
                const position = index + 1;
                let positionClass = '';
                if (position === 1) positionClass = 'first';
                else if (position === 2) positionClass = 'second';
                else if (position === 3) positionClass = 'third';

                const photoHtml = result.foto_profilo ?
                    `<img src="/static/uploads/${result.foto_profilo}" alt="${result.nome}">` :
                    '👤';

                html += `
                    <div class="result-item">
                        <div class="result-position ${positionClass}">${position}°</div>
                        <div class="result-avatar">${photoHtml}</div>
                        <div class="result-info">
                            <div class="result-name">${result.nome}</div>
                            <div class="result-details">${result.squadra} - ${result.personaggio}</div>
                        </div>
                        <div class="result-score">
                            <div class="result-points">${result.total_points}</div>
                            <div class="result-breakdown">
                                1°: ${result.first_votes} | 2°: ${result.second_votes} | 3°: ${result.third_votes}
                            </div>
                        </div>
                    </div>
                `;
            });

            container.innerHTML = html;
        }

        function resetVotazione() {
            if (!confirm('Sei sicuro di voler resettare TUTTI i voti della votazione costumi? Questa azione non può essere annullata!')) return;

            fetch('/api/gamemaster/votazione-costumi/reset', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                }
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    showNotification('Votazione costumi resettata!', 'success');
                    loadVotazioneStats();
                } else {
                    showNotification(data.error || 'Errore reset votazione', 'error');
                }
            })
            .catch(error => {
                showNotification('Errore di connessione', 'error');
            });
        }

        function exportVotazioneResults() {
            if (!votazioneStats.general_stats || votazioneStats.general_stats.total_voters === 0) {
                showNotification('Nessun dato da esportare', 'warning');
                return;
            }

            // Genera dati per export
            const exportData = {
                data_export: new Date().toISOString(),
                statistiche_generali: votazioneStats.general_stats,
                votanti: votazioneStats.voters,
                non_votanti: votazioneStats.non_voters,
                analisi_categorie: votazioneStats.top_by_category
            };

            const dataStr = JSON.stringify(exportData, null, 2);
            const dataBlob = new Blob([dataStr], {type: 'application/json'});

            const link = document.createElement('a');
            link.href = URL.createObjectURL(dataBlob);
            link.download = `votazione_costumi_${new Date().toISOString().split('T')[0]}.json`;
            link.click();

            showNotification('📊 Risultati esportati!', 'success');
        }

        // === FUNZIONI GIOCATORI ===
        function loadPlayers() {
            fetch('/api/gamemaster/players')
                .then(response => response.json())
                .then(data => {
                    players = data;
                    updatePlayersDisplay();
                })
                .catch(error => {
                    console.error('Errore caricamento giocatori:', error);
                });
        }

        function updatePlayersDisplay() {
            const container = document.getElementById('players-grid');
            if (players.length === 0) {
                container.innerHTML = '<p style="text-align: center; opacity: 0.7;">Nessun giocatore registrato</p>';
                return;
            }

            let html = '';
            players.forEach(player => {
                html += `
                    <div class="player-card">
                        <div class="player-header">
                            <div class="player-avatar">
                                ${player.foto_profilo ?
                                  `<img src="/static/uploads/${player.foto_profilo}" alt="${player.nome}">` :
                                  '👤'
                                }
                            </div>
                            <div class="player-info">
                                <h4>${player.nome}</h4>
                                <p>Squadra ${player.squadra}</p>
                                <p style="font-size: 0.9em; opacity: 0.8;">${player.personaggio}</p>
                            </div>
                        </div>
                        <div class="player-stats">
                            <div class="stat">
                                <div class="stat-value">${player.punti_totali}</div>
                                <div class="stat-label">Punti</div>
                            </div>
                            <div class="stat">
                                <div class="stat-value">${player.escluso_da_gioco ? '❌' : '✅'}</div>
                                <div class="stat-label">Attivo</div>
                            </div>
                        </div>
                        <div style="margin-top: 15px; text-align: center;">
                            <button class="btn btn-warning" onclick="togglePlayerStatus(${player.id})" style="padding: 8px 15px; font-size: 0.9em;">
                                ${player.escluso_da_gioco ? '✅ Riattiva' : '❌ Escludi'}
                            </button>
                        </div>
                    </div>
                `;
            });
            container.innerHTML = html;
        }

        function togglePlayerStatus(playerId) {
            const player = players.find(p => p.id === playerId);
            if (!player) return;

            const action = player.escluso_da_gioco ? 'riattivare' : 'escludere';
            if (!confirm(`Sei sicuro di voler ${action} ${player.nome}?`)) return;

            fetch(`/api/gamemaster/players/${playerId}/toggle-status`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                }
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    showNotification(`Giocatore ${action} con successo`, 'success');
                    loadPlayers();
                } else {
                    showNotification(data.error || 'Errore modifica stato', 'error');
                }
            })
            .catch(error => {
                showNotification('Errore di rete', 'error');
            });
        }

        function resetAllScores() {
            if (!confirm('Sei sicuro di voler resettare tutti i punteggi? Questa azione cancellerà anche tutte le risposte e partite. NON PUÒ ESSERE ANNULLATA.')) return;

            fetch('/api/gamemaster/reset-scores', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                }
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    showNotification('Tutti i punteggi sono stati resettati!', 'success');
                    loadPlayers();
                } else {
                    showNotification(data.error || 'Errore reset punteggi', 'error');
                }
            })
            .catch(error => {
                showNotification('Errore di rete', 'error');
            });
        }

        // === GESTIONE MODAL INDIZI ===
        function setupModal() {
            const modal = document.getElementById('clues-modal');
            const span = document.querySelector('.close');

            span.onclick = function() {
                modal.style.display = 'none';
            }

            window.onclick = function(event) {
                if (event.target == modal) {
                    modal.style.display = 'none';
                }
            }
        }

        function manageClues(personId, personName) {
            document.getElementById('clue-person-id').value = personId;
            document.getElementById('modal-person-name').textContent = `Gestione Indizi - ${personName}`;
            document.getElementById('clues-modal').style.display = 'block';
            loadClues(personId);
        }

        function loadClues(personId) {
            fetch(`/api/gamemaster/indovina-indizi/${personId}`)
                .then(response => response.json())
                .then(data => {
                    updateCluesDisplay(data);
                })
                .catch(error => {
                    console.error('Errore caricamento indizi:', error);
                });
        }

        function updateCluesDisplay(clues) {
            const container = document.getElementById('clues-list-modal');
            if (clues.length === 0) {
                container.innerHTML = '<p style="text-align: center; opacity: 0.7;">Nessun indizio configurato</p>';
                return;
            }

            let html = '<h4 style="margin-bottom: 15px;">Indizi Esistenti:</h4>';
            clues.forEach(clue => {
                html += `
                    <div class="clue-item">
                        <div>
                            <strong>Ordine ${clue.ordine}:</strong> ${clue.indizio}
                            <span style="color: #ffd700;">(${clue.punti} punti)</span>
                        </div>
                        <button class="btn btn-danger" onclick="deleteClue(${clue.id})" style="padding: 5px 10px; font-size: 0.8em;">🗑️</button>
                    </div>
                `;
            });
            container.innerHTML = html;
        }

        function handleClueSubmit(event) {
            event.preventDefault();

            const formData = {
                persona_id: document.getElementById('clue-person-id').value,
                indizio: document.getElementById('clue-text').value.trim(),
                ordine: parseInt(document.getElementById('clue-order').value),
                punti: parseInt(document.getElementById('clue-points').value)
            };

            if (!formData.indizio) {
                showNotification('L\'indizio è obbligatorio', 'error');
                return;
            }

            fetch('/api/gamemaster/indovina-indizi', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(formData)
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    showNotification('Indizio aggiunto!', 'success');
                    document.getElementById('clue-form').reset();
                    document.getElementById('clue-order').value = '1';
                    document.getElementById('clue-points').value = '50';
                    loadClues(formData.persona_id);
                } else {
                    showNotification(data.error || 'Errore aggiunta indizio', 'error');
                }
            })
            .catch(error => {
                showNotification('Errore aggiunta indizio', 'error');
            });
        }

        function deleteClue(clueId) {
            if (!confirm('Sei sicuro di voler eliminare questo indizio?')) return;

            fetch(`/api/gamemaster/indovina-indizi/${clueId}`, {
                method: 'DELETE'
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    showNotification('Indizio eliminato', 'success');
                    const personId = document.getElementById('clue-person-id').value;
                    loadClues(personId);
                    loadIndovinaPeople();
                } else {
                    showNotification('Errore eliminazione indizio', 'error');
                }
            })
            .catch(error => {
                showNotification('Errore eliminazione indizio', 'error');
            });
        }

        // === UTILITY FUNCTIONS ===
        function showNotification(message, type = 'info') {
            // Rimuovi notifiche esistenti
            const existing = document.querySelector('.notification');
            if (existing) {
                existing.remove();
            }

            const notification = document.createElement('div');
            notification.className = `notification ${type}`;
            notification.textContent = message;
            document.body.appendChild(notification);

            // Mostra notifica
            setTimeout(() => {
                notification.classList.add('show');
            }, 100);

            // Nasconde dopo 4 secondi
            setTimeout(() => {
                notification.classList.remove('show');
                setTimeout(() => {
                    notification.remove();
                }, 400);
            }, 4000);
        }
    </script>
</body>
</html>