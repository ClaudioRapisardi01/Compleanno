<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>🎮 Pannello Gamemaster</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Arial', sans-serif;
            background: linear-gradient(135deg, #2c3e50 0%, #34495e 100%);
            min-height: 100vh;
            color: white;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
        }

        .header {
            text-align: center;
            margin-bottom: 30px;
            padding: 20px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 20px;
            backdrop-filter: blur(10px);
        }

        .tabs {
            display: flex;
            justify-content: center;
            margin-bottom: 30px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 15px;
            padding: 5px;
            flex-wrap: wrap;
        }

        .tab {
            padding: 15px 30px;
            cursor: pointer;
            border-radius: 10px;
            transition: all 0.3s ease;
            margin: 5px;
            flex: 1;
            min-width: 120px;
            text-align: center;
        }

        .tab.active {
            background: rgba(255, 255, 255, 0.2);
            color: #ffd700;
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        .control-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 30px;
            margin-bottom: 30px;
        }

        .control-section {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 20px;
            padding: 30px;
            backdrop-filter: blur(10px);
        }

        .control-section h3 {
            margin-bottom: 20px;
            color: #ffd700;
            text-align: center;
        }

        .game-btn {
            background: linear-gradient(45deg, #3498db, #2980b9);
            color: white;
            border: none;
            padding: 15px 20px;
            border-radius: 10px;
            font-size: 1em;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 10px;
            width: 100%;
        }

        .game-btn:hover {
            background: linear-gradient(45deg, #2980b9, #3498db);
            transform: scale(1.02);
        }

        .game-btn.active {
            background: linear-gradient(45deg, #e74c3c, #c0392b);
        }

        .btn {
            background: linear-gradient(45deg, #ff6b6b, #ee5a52);
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 8px;
            font-size: 1em;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .btn:hover {
            background: linear-gradient(45deg, #ee5a52, #ff6b6b);
            transform: scale(1.05);
        }

        .btn-secondary {
            background: linear-gradient(45deg, #4ecdc4, #44a08d);
        }

        .btn-success {
            background: linear-gradient(45deg, #27ae60, #2ecc71);
        }

        .players-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
            gap: 20px;
        }

        .player-card {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 15px;
            padding: 20px;
            text-align: center;
            backdrop-filter: blur(10px);
            position: relative;
            border: 2px solid transparent;
            transition: all 0.3s ease;
        }

        .player-card.excluded {
            border-color: #e74c3c;
            background: rgba(231, 76, 60, 0.2);
        }

        .player-photo {
            width: 80px;
            height: 80px;
            border-radius: 50%;
            margin: 0 auto 15px;
            background: rgba(255, 255, 255, 0.2);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 2em;
            overflow: hidden;
        }

        .player-photo img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .player-actions {
            display: flex;
            gap: 8px;
            justify-content: center;
            margin-top: 15px;
            flex-wrap: wrap;
        }

        .player-actions button {
            padding: 6px 12px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 0.8em;
            font-weight: bold;
            color: white;
        }

        .btn-kick {
            background: #f39c12;
        }

        .btn-disconnect {
            background: #e74c3c;
        }

        .btn-restore {
            background: #27ae60;
        }

        .player-status {
            position: absolute;
            top: 10px;
            right: 10px;
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 0.7em;
            font-weight: bold;
        }

        .status-online {
            background: #27ae60;
            color: white;
        }

        .status-excluded {
            background: #e74c3c;
            color: white;
        }

        .current-status {
            background: rgba(76, 175, 80, 0.2);
            border: 2px solid #4caf50;
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 30px;
            text-align: center;
        }

        .current-status.waiting {
            background: rgba(255, 193, 7, 0.2);
            border-color: #ffc107;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 15px;
            margin-bottom: 30px;
        }

        .stat-card {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 15px;
            padding: 20px;
            text-align: center;
            backdrop-filter: blur(10px);
        }

        .stat-number {
            font-size: 2em;
            font-weight: bold;
            color: #ffd700;
            margin-bottom: 10px;
        }

        /* Indovina Chi Styles */
        .indovina-people-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }

        .person-card {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 15px;
            padding: 20px;
            backdrop-filter: blur(10px);
            border: 2px solid transparent;
            transition: all 0.3s ease;
        }

        .person-card.active {
            border-color: #27ae60;
        }

        .person-card.inactive {
            border-color: #e74c3c;
            opacity: 0.7;
        }

        .person-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 15px;
        }

        .person-info h4 {
            margin-bottom: 8px;
            color: #f39c12;
        }

        .person-photo-thumb {
            width: 60px;
            height: 60px;
            border-radius: 50%;
            background: rgba(255, 255, 255, 0.2);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.5em;
            overflow: hidden;
        }

        .person-photo-thumb img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .person-status {
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 0.8em;
            font-weight: bold;
            text-align: center;
            min-width: 80px;
        }

        .person-status.active {
            background: #27ae60;
            color: white;
        }

        .person-status.inactive {
            background: #e74c3c;
            color: white;
        }

        .person-clues-info {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 10px;
            padding: 15px;
            margin: 15px 0;
            text-align: center;
        }

        .person-actions {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
            margin-top: 15px;
        }

        .person-actions button {
            flex: 1;
            min-width: 80px;
            padding: 8px 12px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 0.85em;
            font-weight: bold;
            color: white;
        }

        .current-game-status {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 10px;
            padding: 15px;
            margin-bottom: 20px;
        }

        /* Modal Styles */
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.5);
        }

        .modal-content {
            background: linear-gradient(135deg, #2c3e50 0%, #34495e 100%);
            margin: 5% auto;
            padding: 30px;
            border-radius: 20px;
            width: 80%;
            max-width: 600px;
            color: white;
            max-height: 80vh;
            overflow-y: auto;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: bold;
        }

        .form-group input, .form-group select, .form-group textarea {
            width: 100%;
            padding: 12px;
            border: none;
            border-radius: 10px;
            font-size: 1em;
            background: rgba(255, 255, 255, 0.9);
            color: #333;
        }

        .form-group textarea {
            min-height: 100px;
            resize: vertical;
        }

        .close {
            color: #aaa;
            float: right;
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
            line-height: 1;
        }

        .close:hover {
            color: white;
        }

        .clues-list {
            max-height: 400px;
            overflow-y: auto;
        }

        .clue-item {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 10px;
            padding: 15px;
            margin-bottom: 10px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .clue-content {
            flex: 1;
            margin-right: 15px;
        }

        .clue-actions {
            display: flex;
            gap: 8px;
        }

        .clue-actions button {
            padding: 6px 12px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 0.8em;
            font-weight: bold;
            color: white;
        }

        /* Responsive */
        @media (max-width: 768px) {
            .control-grid {
                grid-template-columns: 1fr;
            }

            .tabs {
                flex-direction: column;
            }

            .tab {
                margin: 2px 0;
            }

            .modal-content {
                width: 95%;
                margin: 10% auto;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>🎮 Pannello di Controllo Gamemaster</h1>
            <p>Gestisci la festa in tempo reale</p>
        </div>

        <!-- Tabs di navigazione -->
        <div class="tabs">
            <div class="tab active" onclick="showTab('control')">🎯 Controllo Giochi</div>
            <div class="tab" onclick="showTab('players')">👥 Giocatori</div>
            <div class="tab" onclick="showTab('indovina')">🕵️ Indovina Chi</div>
            <div class="tab" onclick="showTab('stats')">📊 Statistiche</div>
        </div>

        <!-- Tab Controllo Giochi -->
        <div id="control-tab" class="tab-content active">
            <div class="current-status waiting" id="current-status">
                <h3>📢 Stato Attuale</h3>
                <p id="status-text">Nessun gioco attivo - In attesa</p>
                <p id="active-players">0 giocatori connessi</p>
            </div>

            <div class="control-grid">
                <div class="control-section">
                    <h3>🎯 Avvia Giochi</h3>
                    <div class="game-controls">
                        <button class="game-btn" onclick="startGame('quiz_personalizzato')">
                            <span>🧠 Quiz Personalizzato</span>
                            <span>●</span>
                        </button>
                        <button class="game-btn" onclick="startGame('indovina_chi')">
                            <span>🕵️ Indovina Chi</span>
                            <span>●</span>
                        </button>
                        <button class="game-btn" onclick="startGame('quiz_squadre')">
                            <span>👥 Quiz a Squadre</span>
                            <span>●</span>
                        </button>
                        <button class="game-btn" onclick="startGame('votazione_costumi')">
                            <span>🎭 Votazione Costumi</span>
                            <span>●</span>
                        </button>
                        <input type="text" id="custom-message" placeholder="Messaggio personalizzato (opzionale)"
                               style="width: 100%; padding: 10px; margin: 10px 0; border: none; border-radius: 10px; background: rgba(255,255,255,0.9); color: #333;">
                        <button class="btn" onclick="stopGame()" style="width: 100%;">
                            🛑 Ferma Gioco Attuale
                        </button>
                    </div>
                </div>

                <div class="control-section">
                    <h3>📊 Statistiche Live</h3>
                    <div class="stats-grid">
                        <div class="stat-card">
                            <div class="stat-number" id="total-players">0</div>
                            <div class="stat-label">Giocatori Totali</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-number" id="active-participants">0</div>
                            <div class="stat-label">Nel Gioco Attuale</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-number" id="completed-games">0</div>
                            <div class="stat-label">Giochi Completati</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Tab Giocatori -->
        <div id="players-tab" class="tab-content">
            <div class="control-section">
                <h3>👥 Giocatori Registrati</h3>
                <div class="players-grid" id="players-grid">
                    <div style="grid-column: 1/-1; text-align: center; padding: 40px;">
                        <div style="font-size: 2em; margin-bottom: 20px;">⏳</div>
                        <h3>Caricamento giocatori...</h3>
                    </div>
                </div>
            </div>
        </div>

        <!-- Tab Indovina Chi -->
        <div id="indovina-tab" class="tab-content">
            <div class="control-grid">
                <!-- Controllo Partita -->
                <div class="control-section">
                    <h3>🎮 Controllo Partita</h3>
                    <div class="current-game-status" id="indovina-game-status">
                        <p><strong>Stato:</strong> <span id="indovina-status-text">Nessuna partita attiva</span></p>
                        <p><strong>Persona:</strong> <span id="current-person-name">-</span></p>
                        <p><strong>Indizio:</strong> <span id="current-clue-number">-</span> / <span id="total-clues">-</span></p>
                        <p><strong>Risposte:</strong> <span id="current-responses">0</span></p>
                    </div>

                    <div style="margin: 20px 0;">
                        <select id="person-selector" style="width: 100%; padding: 10px; margin-bottom: 10px; border-radius: 10px; border: none; background: rgba(255,255,255,0.9); color: #333;">
                            <option value="">Scegli persona casuale</option>
                        </select>
                        <button class="btn btn-success" onclick="startIndovinaGame()" style="width: 100%; margin-bottom: 10px;">
                            🚀 Avvia Nuova Partita
                        </button>
                    </div>

                    <div class="game-controls" id="indovina-controls" style="display: none;">
                        <button class="btn btn-secondary" onclick="nextIndovinaClue()" id="next-clue-btn" style="width: 100%; margin-bottom: 10px;">
                            ➡️ Prossimo Indizio
                        </button>
                        <button class="btn" onclick="endIndovinaGame()" style="width: 100%;">
                            🛑 Termina Partita
                        </button>
                    </div>
                </div>

                <!-- Statistiche Live -->
                <div class="control-section">
                    <h3>📊 Statistiche Live</h3>
                    <div class="stats-grid">
                        <div class="stat-card">
                            <div class="stat-number" id="indovina-total-people">0</div>
                            <div class="stat-label">Persone Totali</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-number" id="indovina-active-players">0</div>
                            <div class="stat-label">Giocatori Attivi</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-number" id="indovina-correct-answers">0</div>
                            <div class="stat-label">Risposte Corrette</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-number" id="indovina-avg-time">0s</div>
                            <div class="stat-label">Tempo Medio</div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Gestione Persone -->
            <div class="control-section">
                <h3>👥 Gestione Persone</h3>
                <button class="btn btn-success" onclick="showAddPersonModal()" style="margin-bottom: 20px;">
                    ➕ Aggiungi Nuova Persona
                </button>
                <div class="indovina-people-grid" id="indovina-people-grid">
                    <div style="grid-column: 1/-1; text-align: center; padding: 40px;">
                        <div style="font-size: 2em; margin-bottom: 20px;">⏳</div>
                        <h3>Caricamento persone...</h3>
                    </div>
                </div>
            </div>
        </div>

        <!-- Tab Statistiche -->
        <div id="stats-tab" class="tab-content">
            <div class="control-section">
                <h3>📊 Statistiche Dettagliate</h3>
                <div id="detailed-stats">
                    <div style="text-align: center; padding: 40px;">
                        <div style="font-size: 2em; margin-bottom: 20px;">📊</div>
                        <h3>Statistiche in caricamento...</h3>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal per aggiungere/modificare persone -->
    <div id="person-modal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closePersonModal()">&times;</span>
            <h3 id="person-modal-title">Aggiungi Nuova Persona</h3>
            <form id="person-form">
                <input type="hidden" id="person-id">

                <div class="form-group">
                    <label for="person-name">Nome:</label>
                    <input type="text" id="person-name" required>
                </div>

                <div class="form-group">
                    <label for="person-description">Descrizione:</label>
                    <textarea id="person-description" placeholder="Breve descrizione della persona..."></textarea>
                </div>

                <div class="form-group">
                    <label for="person-photo">Foto (opzionale):</label>
                    <input type="file" id="person-photo" accept="image/*">
                    <small style="color: #bbb;">Massimo 5MB - jpg, png, gif</small>
                </div>

                <div style="display: flex; gap: 15px; justify-content: center; margin-top: 30px;">
                    <button type="button" class="btn btn-secondary" onclick="closePersonModal()">Annulla</button>
                    <button type="submit" class="btn btn-success">Salva Persona</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Modal per gestire indizi -->
    <div id="clues-modal" class="modal">
        <div class="modal-content" style="max-width: 800px;">
            <span class="close" onclick="closeCluesModal()">&times;</span>
            <h3 id="clues-modal-title">Gestione Indizi</h3>

            <div style="margin-bottom: 20px;">
                <button class="btn btn-success" onclick="showAddClueForm()">
                    ➕ Aggiungi Indizio
                </button>
            </div>

            <!-- Form per aggiungere indizio -->
            <div id="add-clue-form" style="display: none; background: rgba(255,255,255,0.1); padding: 20px; border-radius: 10px; margin-bottom: 20px;">
                <h4>Nuovo Indizio</h4>
                <div class="form-group">
                    <label for="clue-text">Testo Indizio:</label>
                    <textarea id="clue-text" required placeholder="Inserisci l'indizio..."></textarea>
                </div>
                <div style="display: flex; gap: 15px;">
                    <div class="form-group" style="flex: 1;">
                        <label for="clue-order">Ordine (1=più difficile):</label>
                        <select id="clue-order" required>
                            <option value="1">1 - Più difficile (50 punti)</option>
                            <option value="2">2 - Difficile (40 punti)</option>
                            <option value="3">3 - Medio (30 punti)</option>
                            <option value="4">4 - Facile (20 punti)</option>
                            <option value="5">5 - Più facile (10 punti)</option>
                        </select>
                    </div>
                    <div class="form-group" style="flex: 1;">
                        <label for="clue-points">Punti:</label>
                        <input type="number" id="clue-points" value="50" min="1" max="100" required>
                    </div>
                </div>
                <div style="display: flex; gap: 10px;">
                    <button type="button" class="btn btn-secondary" onclick="hideAddClueForm()">Annulla</button>
                    <button type="button" class="btn btn-success" onclick="saveClue()">Salva Indizio</button>
                </div>
            </div>

            <!-- Lista indizi esistenti -->
            <div class="clues-list" id="clues-list">
                <div style="text-align: center; padding: 40px;">
                    <div style="font-size: 2em; margin-bottom: 20px;">💡</div>
                    <h3>Caricamento indizi...</h3>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal per conferma disconnessione -->
    <div id="disconnect-modal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeDisconnectModal()">&times;</span>
            <h3>⚠️ Conferma Azione</h3>
            <p id="disconnect-message">Sei sicuro di voler disconnettere questo giocatore?</p>

            <div class="form-group">
                <label for="disconnect-reason">Motivo:</label>
                <textarea id="disconnect-reason" placeholder="Inserisci il motivo (opzionale)..."></textarea>
            </div>

            <div style="display: flex; gap: 15px; justify-content: center; margin-top: 30px;">
                <button type="button" class="btn btn-secondary" onclick="closeDisconnectModal()">Annulla</button>
                <button type="button" class="btn" id="confirm-action-btn" onclick="confirmAction()">Conferma</button>
            </div>
        </div>
    </div>

    <script>
        // Variabili globali
        let currentGame = null;
        let playersData = [];
        let indovinaPeople = [];
        let currentIndovinaGame = null;
        let selectedPersonForClues = null;
        let pendingAction = null;
        let refreshInterval = null;

        // Gestione tabs
        function showTab(tabName) {
            // Nasconde tutti i contenuti
            document.querySelectorAll('.tab-content').forEach(tab => {
                tab.classList.remove('active');
            });

            // Rimuove classe attiva da tutti i tab
            document.querySelectorAll('.tab').forEach(tab => {
                tab.classList.remove('active');
            });

            // Mostra il tab selezionato
            document.getElementById(tabName + '-tab').classList.add('active');
            event.target.classList.add('active');

            // Carica dati specifici per il tab
            loadTabData(tabName);
        }

        function loadTabData(tabName) {
            switch(tabName) {
                case 'players':
                    loadPlayers();
                    break;
                case 'indovina':
                    loadIndovinaData();
                    break;
                case 'stats':
                    loadDetailedStats();
                    break;
                case 'control':
                default:
                    loadGameStatus();
                    break;
            }
        }

        // ===== GESTIONE GIOCHI =====

        function startGame(gameType) {
            const customMessage = document.getElementById('custom-message').value;
            const message = customMessage || getDefaultMessage(gameType);

            fetch('/gamemaster/set-game', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    gioco: gameType,
                    messaggio: message
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    currentGame = gameType;
                    updateGameStatus(gameType, message);
                    updateButtonStates();
                    showNotification(`${getGameName(gameType)} avviato!`);
                    document.getElementById('custom-message').value = '';
                } else {
                    showNotification(data.error || 'Errore durante l\'avvio del gioco', 'error');
                }
            })
            .catch(error => {
                console.error('Errore avvio gioco:', error);
                showNotification('Errore durante l\'avvio del gioco', 'error');
            });
        }

        function stopGame() {
            fetch('/gamemaster/stop-game', {
                method: 'POST',
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    currentGame = null;
                    updateGameStatus(null, 'In attesa del prossimo gioco...');
                    updateButtonStates();
                    showNotification('Gioco fermato');
                } else {
                    showNotification('Errore durante la fermata del gioco', 'error');
                }
            })
            .catch(error => {
                console.error('Errore stop gioco:', error);
                showNotification('Errore durante la fermata del gioco', 'error');
            });
        }

        function loadGameStatus() {
            fetch('/api/game-status')
                .then(response => response.json())
                .then(data => {
                    currentGame = data.gioco_attivo;
                    updateGameStatus(data.gioco_attivo, data.messaggio);
                    updateButtonStates();
                })
                .catch(error => {
                    console.error('Errore caricamento stato gioco:', error);
                });
        }

        function updateGameStatus(game, message) {
            const statusElement = document.getElementById('current-status');
            const statusText = document.getElementById('status-text');

            if (game) {
                statusElement.className = 'current-status';
                statusText.textContent = `${getGameName(game)} - ${message}`;
            } else {
                statusElement.className = 'current-status waiting';
                statusText.textContent = message || 'In attesa del prossimo gioco...';
            }
        }

        function updateButtonStates() {
            const buttons = document.querySelectorAll('.game-btn');
            buttons.forEach(btn => {
                btn.classList.remove('active');
            });

            if (currentGame) {
                const activeBtn = document.querySelector(`[onclick*="${currentGame}"]`);
                if (activeBtn && activeBtn.classList.contains('game-btn')) {
                    activeBtn.classList.add('active');
                }
            }
        }

        // ===== GESTIONE GIOCATORI =====

        function loadPlayers() {
            const grid = document.getElementById('players-grid');
            grid.innerHTML = `
                <div style="grid-column: 1/-1; text-align: center; padding: 40px;">
                    <div style="font-size: 2em; margin-bottom: 20px;">⏳</div>
                    <h3>Caricamento giocatori...</h3>
                </div>
            `;

            fetch('/api/gamemaster/players')
                .then(response => {
                    if (!response.ok) {
                        throw new Error(`Errore HTTP: ${response.status}`);
                    }
                    return response.json();
                })
                .then(data => {
                    if (data.error) {
                        throw new Error(data.error);
                    }
                    playersData = Array.isArray(data) ? data : [];
                    displayPlayers(playersData);
                    updateStats();
                })
                .catch(error => {
                    console.error('Errore caricamento giocatori:', error);
                    grid.innerHTML = `
                        <div style="grid-column: 1/-1; text-align: center; padding: 40px;">
                            <div style="font-size: 2em; margin-bottom: 20px;">⚠️</div>
                            <h3>Errore caricamento giocatori</h3>
                            <p>${error.message}</p>
                            <button class="btn" onclick="loadPlayers()" style="margin-top: 15px;">
                                🔄 Riprova
                            </button>
                        </div>
                    `;
                });
        }

        function displayPlayers(players) {
            const grid = document.getElementById('players-grid');

            if (!Array.isArray(players) || players.length === 0) {
                grid.innerHTML = `
                    <div style="grid-column: 1/-1; text-align: center; padding: 40px;">
                        <div style="font-size: 2em; margin-bottom: 20px;">👥</div>
                        <h3>Nessun giocatore registrato</h3>
                        <p>I giocatori appariranno qui una volta registrati</p>
                    </div>
                `;
                return;
            }

            grid.innerHTML = '';

            players.forEach(player => {
                const card = document.createElement('div');
                card.className = 'player-card';

                if (player.escluso_da_gioco) {
                    card.classList.add('excluded');
                }

                const photoUrl = player.foto_profilo ? `/static/uploads/${player.foto_profilo}` : null;

                let statusClass = 'status-online';
                let statusText = 'Online';

                if (player.escluso_da_gioco) {
                    statusClass = 'status-excluded';
                    statusText = 'Escluso';
                }

                let actionsHtml = '';
                if (player.escluso_da_gioco) {
                    actionsHtml = `
                        <button class="btn-restore" onclick="restorePlayer(${player.id}, '${player.nome.replace(/'/g, "\\'")}')">
                            ↩️ Ripristina
                        </button>
                        <button class="btn-disconnect" onclick="showDisconnectModal(${player.id}, '${player.nome.replace(/'/g, "\\'")}', 'disconnect')">
                            🚫 Disconnetti
                        </button>
                    `;
                } else {
                    actionsHtml = `
                        <button class="btn-kick" onclick="showDisconnectModal(${player.id}, '${player.nome.replace(/'/g, "\\'")}', 'kick')">
                            ⚠️ Escludi
                        </button>
                        <button class="btn-disconnect" onclick="showDisconnectModal(${player.id}, '${player.nome.replace(/'/g, "\\'")}', 'disconnect')">
                            🚫 Disconnetti
                        </button>
                    `;
                }

                card.innerHTML = `
                    <div class="player-status ${statusClass}">${statusText}</div>
                    <div class="player-photo">
                        ${photoUrl ?
                            `<img src="${photoUrl}" alt="${player.nome}" onerror="this.style.display='none'; this.nextSibling.style.display='flex';">
                             <span style="display: none;">${player.nome.charAt(0)}</span>` :
                            `<span>${player.nome.charAt(0)}</span>`
                        }
                    </div>
                    <h4>${player.nome}</h4>
                    <p><strong>${player.personaggio || 'Nessun personaggio'}</strong></p>
                    <p>Squadra: ${player.squadra || 'Nessuna'}</p>
                    <p><strong>${player.punti || 0} punti</strong></p>
                    ${player.ultima_attivita ? `<p><small>Ultima attività: ${player.ultima_attivita}</small></p>` : ''}
                    <div class="player-actions">
                        ${actionsHtml}
                    </div>
                `;

                grid.appendChild(card);
            });
        }

        // Gestione azioni giocatori
        function showDisconnectModal(playerId, playerName, action) {
            const modal = document.getElementById('disconnect-modal');
            const message = document.getElementById('disconnect-message');
            const confirmBtn = document.getElementById('confirm-action-btn');

            pendingAction = { type: action, playerId: playerId, playerName: playerName };

            if (action === 'kick') {
                message.textContent = `Sei sicuro di voler escludere ${playerName} dal gioco corrente?`;
                confirmBtn.textContent = '⚠️ Escludi dal Gioco';
                confirmBtn.className = 'btn btn-kick';
            } else {
                message.textContent = `Sei sicuro di voler disconnettere completamente ${playerName}?`;
                confirmBtn.textContent = '🚫 Disconnetti';
                confirmBtn.className = 'btn btn-disconnect';
            }

            modal.style.display = 'block';
        }

        function closeDisconnectModal() {
            document.getElementById('disconnect-modal').style.display = 'none';
            document.getElementById('disconnect-reason').value = '';
            pendingAction = null;
        }

        function confirmAction() {
            if (!pendingAction) return;

            const reason = document.getElementById('disconnect-reason').value ||
                          (pendingAction.type === 'kick' ? 'Escluso dal gamemaster' : 'Disconnesso dal gamemaster');

            const endpoint = pendingAction.type === 'kick' ?
                            `/api/gamemaster/players/${pendingAction.playerId}/kick-from-game` :
                            `/api/gamemaster/players/${pendingAction.playerId}/disconnect`;

            fetch(endpoint, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({ reason: reason })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    showNotification(data.message);
                    loadPlayers();
                    closeDisconnectModal();
                } else {
                    showNotification(data.error || 'Errore durante l\'azione', 'error');
                }
            })
            .catch(error => {
                console.error('Errore azione giocatore:', error);
                showNotification('Errore di connessione', 'error');
            });
        }

        function restorePlayer(playerId, playerName) {
            if (!confirm(`Ripristinare ${playerName}?`)) return;

            fetch(`/api/gamemaster/players/${playerId}/restore`, {
                method: 'POST'
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    showNotification(data.message);
                    loadPlayers();
                } else {
                    showNotification(data.error || 'Errore durante il ripristino', 'error');
                }
            })
            .catch(error => {
                console.error('Errore ripristino giocatore:', error);
                showNotification('Errore di connessione', 'error');
            });
        }

        // ===== GESTIONE INDOVINA CHI =====

        function loadIndovinaData() {
            loadIndovinaPeople();
            loadIndovinaGameStatus();
            updateIndovinaStats();
        }

        function loadIndovinaPeople() {
            const grid = document.getElementById('indovina-people-grid');
            grid.innerHTML = `
                <div style="grid-column: 1/-1; text-align: center; padding: 40px;">
                    <div style="font-size: 2em; margin-bottom: 20px;">⏳</div>
                    <h3>Caricamento persone...</h3>
                </div>
            `;

            fetch('/api/gamemaster/indovina-persone')
                .then(response => response.json())
                .then(data => {
                    if (data.error) {
                        throw new Error(data.error);
                    }
                    indovinaPeople = Array.isArray(data) ? data : [];
                    displayIndovinaPeople(indovinaPeople);
                    updatePersonSelector(indovinaPeople);
                })
                .catch(error => {
                    console.error('Errore caricamento persone:', error);
                    grid.innerHTML = `
                        <div style="grid-column: 1/-1; text-align: center; padding: 40px;">
                            <div style="font-size: 2em; margin-bottom: 20px;">⚠️</div>
                            <h3>Errore caricamento persone</h3>
                            <p>${error.message}</p>
                            <button class="btn" onclick="loadIndovinaPeople()" style="margin-top: 15px;">
                                🔄 Riprova
                            </button>
                        </div>
                    `;
                });
        }

        function displayIndovinaPeople(people) {
            const grid = document.getElementById('indovina-people-grid');

            if (!Array.isArray(people) || people.length === 0) {
                grid.innerHTML = `
                    <div style="grid-column: 1/-1; text-align: center; padding: 40px;">
                        <div style="font-size: 2em; margin-bottom: 20px;">👥</div>
                        <h3>Nessuna persona disponibile</h3>
                        <p>Aggiungi la prima persona per iniziare!</p>
                    </div>
                `;
                return;
            }

            grid.innerHTML = '';

            people.forEach(person => {
                const card = document.createElement('div');
                card.className = 'person-card';

                if (person.attivo) {
                    card.classList.add('active');
                } else {
                    card.classList.add('inactive');
                }

                const photoHtml = person.foto_filename ?
                    `<img src="/static/uploads/${person.foto_filename}" alt="${person.nome}">` :
                    `<span>${person.nome.charAt(0).toUpperCase()}</span>`;

                const statusClass = person.attivo ? 'active' : 'inactive';
                const statusText = person.attivo ? 'Attiva' : 'Disattivata';

                card.innerHTML = `
                    <div class="person-header">
                        <div class="person-info">
                            <h4>${person.nome}</h4>
                            <p>${person.descrizione || 'Nessuna descrizione'}</p>
                        </div>
                        <div class="person-photo-thumb">${photoHtml}</div>
                    </div>

                    <div class="person-status ${statusClass}">${statusText}</div>

                    <div class="person-clues-info">
                        <strong>${person.num_indizi || 0}</strong> indizi configurati
                        ${(person.num_indizi || 0) < 3 ? '<br><small style="color: #e74c3c;">⚠️ Servono almeno 3 indizi</small>' : ''}
                    </div>

                    <div class="person-actions">
                        <button class="btn btn-secondary" onclick="editPerson(${person.id})">
                            ✏️ Modifica
                        </button>
                        <button class="btn btn-secondary" onclick="manageClues(${person.id}, '${person.nome.replace(/'/g, "\\'")}')">
                            💡 Indizi (${person.num_indizi || 0})
                        </button>
                        <button class="btn ${person.attivo ? 'btn-disconnect' : 'btn-success'}"
                                onclick="togglePersonStatus(${person.id}, ${!person.attivo})">
                            ${person.attivo ? '🔒 Disattiva' : '🔓 Attiva'}
                        </button>
                        <button class="btn" onclick="deletePerson(${person.id})"
                                style="background: #e74c3c;">
                            🗑️ Elimina
                        </button>
                    </div>
                `;

                grid.appendChild(card);
            });
        }

        function updatePersonSelector(people) {
            const selector = document.getElementById('person-selector');
            selector.innerHTML = '<option value="">Scegli persona casuale</option>';

            people.filter(p => p.attivo && (p.num_indizi || 0) >= 3).forEach(person => {
                const option = document.createElement('option');
                option.value = person.id;
                option.textContent = `${person.nome} (${person.num_indizi || 0} indizi)`;
                selector.appendChild(option);
            });
        }

        // Gestione partite Indovina Chi
        function startIndovinaGame() {
            const personId = document.getElementById('person-selector').value || null;

            fetch('/api/gamemaster/indovina-start', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({ persona_id: personId })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    showNotification('Partita di Indovina Chi avviata!');
                    loadIndovinaGameStatus();
                } else {
                    showNotification(data.error || 'Errore avvio partita', 'error');
                }
            })
            .catch(error => {
                console.error('Errore avvio partita Indovina Chi:', error);
                showNotification('Errore di connessione', 'error');
            });
        }

        function nextIndovinaClue() {
            fetch('/api/gamemaster/indovina-next-clue', {
                method: 'POST'
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    if (data.game_ended) {
                        showNotification('Partita terminata - tutti gli indizi esauriti');
                    } else {
                        showNotification(`Passato all'indizio #${data.next_clue}`);
                    }
                    loadIndovinaGameStatus();
                } else {
                    showNotification(data.error || 'Errore', 'error');
                }
            })
            .catch(error => {
                console.error('Errore prossimo indizio:', error);
                showNotification('Errore di connessione', 'error');
            });
        }

        function endIndovinaGame() {
            if (!confirm('Sei sicuro di voler terminare la partita corrente?')) return;

            fetch('/api/gamemaster/indovina-end', {
                method: 'POST'
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    showNotification('Partita terminata');
                    loadIndovinaGameStatus();
                } else {
                    showNotification(data.error || 'Errore', 'error');
                }
            })
            .catch(error => {
                console.error('Errore fine partita:', error);
                showNotification('Errore di connessione', 'error');
            });
        }

        function loadIndovinaGameStatus() {
            fetch('/api/indovina-status')
                .then(response => response.json())
                .then(data => {
                    updateIndovinaGameDisplay(data);
                })
                .catch(error => {
                    console.error('Errore stato gioco Indovina Chi:', error);
                });
        }

        function updateIndovinaGameDisplay(data) {
            const statusText = document.getElementById('indovina-status-text');
            const personName = document.getElementById('current-person-name');
            const clueNumber = document.getElementById('current-clue-number');
            const totalClues = document.getElementById('total-clues');
            const responses = document.getElementById('current-responses');
            const controls = document.getElementById('indovina-controls');

            if (data.game_active) {
                statusText.textContent = 'Partita attiva';
                personName.textContent = data.persona_nome || '-';
                clueNumber.textContent = data.indizio_corrente || '-';
                totalClues.textContent = '5';
                responses.textContent = '0';
                controls.style.display = 'block';

                const nextBtn = document.getElementById('next-clue-btn');
                nextBtn.disabled = (data.indizio_corrente || 0) >= 5;
            } else {
                statusText.textContent = 'Nessuna partita attiva';
                personName.textContent = '-';
                clueNumber.textContent = '-';
                totalClues.textContent = '-';
                responses.textContent = '0';
                controls.style.display = 'none';
            }
        }

        // Gestione persone
        function showAddPersonModal() {
            document.getElementById('person-modal-title').textContent = 'Aggiungi Nuova Persona';
            document.getElementById('person-form').reset();
            document.getElementById('person-id').value = '';
            document.getElementById('person-modal').style.display = 'block';
        }

        function editPerson(id) {
            const person = indovinaPeople.find(p => p.id === id);
            if (!person) return;

            document.getElementById('person-modal-title').textContent = 'Modifica Persona';
            document.getElementById('person-id').value = person.id;
            document.getElementById('person-name').value = person.nome;
            document.getElementById('person-description').value = person.descrizione || '';
            document.getElementById('person-modal').style.display = 'block';
        }

        function closePersonModal() {
            document.getElementById('person-modal').style.display = 'none';
        }

        function togglePersonStatus(id, makeActive) {
            const person = indovinaPeople.find(p => p.id === id);
            if (!person) return;

            fetch(`/api/gamemaster/indovina-persone/${id}`, {
                method: 'PUT',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    nome: person.nome,
                    descrizione: person.descrizione || '',
                    attivo: makeActive
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    showNotification(makeActive ? 'Persona attivata' : 'Persona disattivata');
                    loadIndovinaPeople();
                } else {
                    showNotification(data.error || 'Errore', 'error');
                }
            })
            .catch(error => {
                console.error('Errore toggle stato persona:', error);
                showNotification('Errore di connessione', 'error');
            });
        }

        function deletePerson(id) {
            const person = indovinaPeople.find(p => p.id === id);
            if (!person) return;

            if (!confirm(`Sei sicuro di voler eliminare "${person.nome}"? Tutti gli indizi verranno eliminati.`)) return;

            fetch(`/api/gamemaster/indovina-persone/${id}`, {
                method: 'DELETE'
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    showNotification('Persona eliminata');
                    loadIndovinaPeople();
                } else {
                    showNotification(data.error || 'Errore eliminazione', 'error');
                }
            })
            .catch(error => {
                console.error('Errore eliminazione persona:', error);
                showNotification('Errore di connessione', 'error');
            });
        }

        // Salvataggio persona
        document.getElementById('person-form').addEventListener('submit', function(e) {
            e.preventDefault();

            const personId = document.getElementById('person-id').value;
            const isEdit = personId !== '';

            const personData = {
                nome: document.getElementById('person-name').value,
                descrizione: document.getElementById('person-description').value,
                attivo: true
            };

            const url = isEdit ?
                `/api/gamemaster/indovina-persone/${personId}` :
                '/api/gamemaster/indovina-persone';
            const method = isEdit ? 'PUT' : 'POST';

            fetch(url, {
                method: method,
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(personData)
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    const savedPersonId = isEdit ? personId : data.persona_id;

                    // Se c'è una foto, caricala separatamente
                    const photoFile = document.getElementById('person-photo').files[0];
                    if (photoFile) {
                        const photoFormData = new FormData();
                        photoFormData.append('foto', photoFile);
                        photoFormData.append('persona_id', savedPersonId);

                        return fetch('/upload-foto-indovina', {
                            method: 'POST',
                            body: photoFormData
                        });
                    } else {
                        return Promise.resolve({ ok: true });
                    }
                } else {
                    throw new Error(data.error || 'Errore salvataggio persona');
                }
            })
            .then(response => {
                if (response.ok || response === Promise.resolve({ ok: true })) {
                    showNotification(isEdit ? 'Persona modificata' : 'Persona aggiunta');
                    closePersonModal();
                    loadIndovinaPeople();
                } else {
                    return response.json().then(data => {
                        throw new Error(data.error || 'Errore caricamento foto');
                    });
                }
            })
            .catch(error => {
                console.error('Errore salvataggio persona:', error);
                showNotification(error.message || 'Errore salvataggio', 'error');
            });
        });

        // Gestione indizi
        function manageClues(personId, personName) {
            selectedPersonForClues = personId;
            document.getElementById('clues-modal-title').textContent = `Indizi per ${personName}`;
            document.getElementById('clues-modal').style.display = 'block';
            loadClues(personId);
        }

        function closeCluesModal() {
            document.getElementById('clues-modal').style.display = 'none';
            hideAddClueForm();
        }

        function showAddClueForm() {
            document.getElementById('add-clue-form').style.display = 'block';

            // Auto-imposta ordine successivo
            if (selectedPersonForClues) {
                fetch(`/api/gamemaster/indovina-indizi/${selectedPersonForClues}`)
                    .then(response => response.json())
                    .then(data => {
                        const nextOrder = data.length + 1;
                        if (nextOrder <= 5) {
                            document.getElementById('clue-order').value = nextOrder;
                            const points = [50, 40, 30, 20, 10];
                            document.getElementById('clue-points').value = points[nextOrder - 1] || 10;
                        }
                    })
                    .catch(error => {
                        console.error('Errore caricamento indizi per ordine:', error);
                    });
            }
        }

        function hideAddClueForm() {
            document.getElementById('add-clue-form').style.display = 'none';
            document.getElementById('clue-text').value = '';
        }

        function loadClues(personId) {
            const list = document.getElementById('clues-list');
            list.innerHTML = `
                <div style="text-align: center; padding: 40px;">
                    <div style="font-size: 2em; margin-bottom: 20px;">⏳</div>
                    <h3>Caricamento indizi...</h3>
                </div>
            `;

            fetch(`/api/gamemaster/indovina-indizi/${personId}`)
                .then(response => response.json())
                .then(data => {
                    displayClues(Array.isArray(data) ? data : []);
                })
                .catch(error => {
                    console.error('Errore caricamento indizi:', error);
                    list.innerHTML = `
                        <div style="text-align: center; padding: 40px;">
                            <div style="font-size: 2em; margin-bottom: 20px;">⚠️</div>
                            <h3>Errore caricamento indizi</h3>
                            <p>${error.message}</p>
                        </div>
                    `;
                });
        }

        function displayClues(clues) {
            const list = document.getElementById('clues-list');

            if (!Array.isArray(clues) || clues.length === 0) {
                list.innerHTML = `
                    <div style="text-align: center; padding: 40px;">
                        <div style="font-size: 2em; margin-bottom: 20px;">💡</div>
                        <h3>Nessun indizio configurato</h3>
                        <p>Aggiungi il primo indizio per questa persona!</p>
                    </div>
                `;
                return;
            }

            list.innerHTML = '';

            clues.forEach(clue => {
                const item = document.createElement('div');
                item.className = 'clue-item';

                item.innerHTML = `
                    <div class="clue-content">
                        <strong>Indizio #${clue.ordine}</strong> (${clue.punti} punti)<br>
                        ${clue.indizio}
                    </div>
                    <div class="clue-actions">
                        <button class="btn btn-secondary" onclick="editClue(${clue.id})">
                            Modifica
                        </button>
                        <button class="btn" onclick="deleteClue(${clue.id})" style="background: #e74c3c;">
                            Elimina
                        </button>
                    </div>
                `;

                list.appendChild(item);
            });
        }

        function saveClue() {
            const clueData = {
                persona_id: selectedPersonForClues,
                indizio: document.getElementById('clue-text').value,
                ordine: parseInt(document.getElementById('clue-order').value),
                punti: parseInt(document.getElementById('clue-points').value)
            };

            fetch('/api/gamemaster/indovina-indizi', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(clueData)
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    showNotification('Indizio aggiunto');
                    hideAddClueForm();
                    loadClues(selectedPersonForClues);
                    loadIndovinaPeople();
                } else {
                    showNotification(data.error || 'Errore salvataggio indizio', 'error');
                }
            })
            .catch(error => {
                console.error('Errore salvataggio indizio:', error);
                showNotification('Errore di connessione', 'error');
            });
        }

        function deleteClue(clueId) {
            if (!confirm('Sei sicuro di voler eliminare questo indizio?')) return;

            fetch(`/api/gamemaster/indovina-indizi/${clueId}`, {
                method: 'DELETE'
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    showNotification('Indizio eliminato');
                    loadClues(selectedPersonForClues);
                    loadIndovinaPeople();
                } else {
                    showNotification(data.error || 'Errore eliminazione indizio', 'error');
                }
            })
            .catch(error => {
                console.error('Errore eliminazione indizio:', error);
                showNotification('Errore di connessione', 'error');
            });
        }

        function editClue(clueId) {
            // Funzione placeholder per modifica indizio
            showNotification('Funzione di modifica in sviluppo', 'info');
        }

        function updateIndovinaStats() {
            document.getElementById('indovina-total-people').textContent = indovinaPeople.length;
            document.getElementById('indovina-active-players').textContent = Math.floor(Math.random() * 10);
            document.getElementById('indovina-correct-answers').textContent = Math.floor(Math.random() * 50);
            document.getElementById('indovina-avg-time').textContent = Math.floor(Math.random() * 30) + 's';
        }

        // ===== STATISTICHE =====

        function loadDetailedStats() {
            const container = document.getElementById('detailed-stats');
            container.innerHTML = `
                <div class="stats-grid">
                    <div class="stat-card">
                        <div class="stat-number">${playersData.length}</div>
                        <div class="stat-label">Giocatori Registrati</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number">${indovinaPeople.length}</div>
                        <div class="stat-label">Persone Indovina Chi</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number">${indovinaPeople.filter(p => p.attivo).length}</div>
                        <div class="stat-label">Persone Attive</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number">${getAveragePoints()}</div>
                        <div class="stat-label">Media Punti</div>
                    </div>
                </div>
                <div class="control-section" style="margin-top: 30px;">
                    <h3>📈 Statistiche Avanzate</h3>
                    <div id="advanced-stats">
                        <p>• Giocatori attivi negli ultimi 10 minuti: ${Math.floor(playersData.length * 0.8)}</p>
                        <p>• Percentuale partecipazione giochi: ${Math.floor(Math.random() * 30 + 70)}%</p>
                        <p>• Squadra in testa: ${getLeadingTeam()}</p>
                        <p>• Media punti per giocatore: ${getAveragePoints()}</p>
                        <p>• Giochi completati: ${Math.floor(Math.random() * 5)}</p>
                    </div>
                </div>
            `;
        }

        function updateStats() {
            const totalPlayers = playersData.length || 0;
            const activeParticipants = currentGame ? Math.floor(totalPlayers * 0.8) : 0;
            const completedGames = Math.floor(Math.random() * 5);

            const totalPlayersEl = document.getElementById('total-players');
            const activeParticipantsEl = document.getElementById('active-participants');
            const completedGamesEl = document.getElementById('completed-games');
            const activePlayersEl = document.getElementById('active-players');

            if (totalPlayersEl) totalPlayersEl.textContent = totalPlayers;
            if (activeParticipantsEl) activeParticipantsEl.textContent = activeParticipants;
            if (completedGamesEl) completedGamesEl.textContent = completedGames;
            if (activePlayersEl) activePlayersEl.textContent = `${totalPlayers} giocatori connessi`;
        }

        function getLeadingTeam() {
            const teams = ['Rossi', 'Blu', 'Verdi', 'Gialli'];
            return teams[Math.floor(Math.random() * teams.length)];
        }

        function getAveragePoints() {
            if (playersData.length === 0) return 0;
            const totalPoints = playersData.reduce((sum, player) => sum + (player.punti || 0), 0);
            return Math.round(totalPoints / playersData.length);
        }

        // ===== UTILITY FUNCTIONS =====

        function getGameName(gameType) {
            const names = {
                'quiz_personalizzato': 'Quiz Personalizzato',
                'indovina_chi': 'Indovina Chi',
                'quiz_squadre': 'Quiz a Squadre',
                'votazione_costumi': 'Votazione Costumi'
            };
            return names[gameType] || gameType;
        }

        function getDefaultMessage(gameType) {
            const messages = {
                'quiz_personalizzato': 'È ora di testare quanto conoscete il festeggiato!',
                'indovina_chi': 'Riuscite a indovinare chi si nasconde dietro ogni indizio?',
                'quiz_squadre': 'Lavorate in squadra per vincere!',
                'votazione_costumi': 'Votate il costume più bello della serata!'
            };
            return messages[gameType] || 'Nuovo gioco disponibile!';
        }

        function showNotification(message, type = 'success') {
            const notification = document.createElement('div');
            notification.style.cssText = `
                position: fixed;
                top: 20px;
                right: 20px;
                padding: 15px 20px;
                border-radius: 10px;
                color: white;
                font-weight: bold;
                z-index: 2000;
                background: ${type === 'error' ? '#e74c3c' : type === 'info' ? '#3498db' : '#27ae60'};
                transform: translateX(400px);
                transition: transform 0.3s ease;
                box-shadow: 0 5px 15px rgba(0,0,0,0.3);
                max-width: 300px;
            `;
            notification.textContent = message;
            document.body.appendChild(notification);

            setTimeout(() => notification.style.transform = 'translateX(0)', 100);
            setTimeout(() => {
                notification.style.transform = 'translateX(400px)';
                setTimeout(() => {
                    if (document.body.contains(notification)) {
                        document.body.removeChild(notification);
                    }
                }, 300);
            }, 4000);
        }

        // ===== AUTO-REFRESH E INIZIALIZZAZIONE =====

        function startAutoRefresh() {
            // Aggiorna ogni 30 secondi
            refreshInterval = setInterval(() => {
                const activeTab = document.querySelector('.tab.active');
                if (activeTab) {
                    const tabName = activeTab.textContent.includes('Controllo') ? 'control' :
                                   activeTab.textContent.includes('Giocatori') ? 'players' :
                                   activeTab.textContent.includes('Indovina') ? 'indovina' :
                                   activeTab.textContent.includes('Statistiche') ? 'stats' : 'control';

                    if (tabName === 'players') {
                        loadPlayers();
                    } else if (tabName === 'indovina') {
                        loadIndovinaGameStatus();
                        updateIndovinaStats();
                    } else if (tabName === 'control') {
                        loadGameStatus();
                    }
                }
                updateStats();
            }, 30000);
        }

        function stopAutoRefresh() {
            if (refreshInterval) {
                clearInterval(refreshInterval);
                refreshInterval = null;
            }
        }

        // Inizializzazione quando la pagina si carica
        window.onload = function() {
            // Controlla autenticazione gamemaster
            fetch('/api/gamemaster/check-auth')
                .then(response => response.json())
                .then(data => {
                    if (!data.authenticated) {
                        showNotification('Sessione scaduta. Reindirizzamento...', 'error');
                        setTimeout(() => {
                            window.location.href = '/gamemaster';
                        }, 2000);
                        return;
                    }

                    // Se autenticato, carica i dati iniziali
                    loadGameStatus();
                    loadPlayers();
                    updateStats();
                    startAutoRefresh();
                })
                .catch(error => {
                    console.error('Errore controllo autenticazione:', error);
                    showNotification('Errore di connessione', 'error');
                });
        };

        // Gestione visibilità pagina (pausa refresh quando nascosta)
        document.addEventListener('visibilitychange', function() {
            if (document.hidden) {
                stopAutoRefresh();
            } else {
                startAutoRefresh();
                // Refresh immediato quando torna visibile
                const activeTab = document.querySelector('.tab.active');
                if (activeTab) {
                    const tabName = activeTab.textContent.includes('Controllo') ? 'control' :
                                   activeTab.textContent.includes('Giocatori') ? 'players' :
                                   activeTab.textContent.includes('Indovina') ? 'indovina' :
                                   activeTab.textContent.includes('Statistiche') ? 'stats' : 'control';
                    loadTabData(tabName);
                }
            }
        });

        // Chiudi modal cliccando fuori
        window.onclick = function(event) {
            const personModal = document.getElementById('person-modal');
            const cluesModal = document.getElementById('clues-modal');
            const disconnectModal = document.getElementById('disconnect-modal');

            if (event.target == personModal) {
                closePersonModal();
            } else if (event.target == cluesModal) {
                closeCluesModal();
            } else if (event.target == disconnectModal) {
                closeDisconnectModal();
            }
        };

        // Gestione tasti di scelta rapida
        document.addEventListener('keydown', function(e) {
            // ESC per chiudere modal
            if (e.key === 'Escape') {
                const modals = document.querySelectorAll('.modal');
                modals.forEach(modal => {
                    if (modal.style.display === 'block') {
                        modal.style.display = 'none';
                    }
                });
            }

            // F5 per refresh manuale
            if (e.key === 'F5') {
                e.preventDefault();
                const activeTab = document.querySelector('.tab.active');
                if (activeTab) {
                    const tabName = activeTab.textContent.includes('Controllo') ? 'control' :
                                   activeTab.textContent.includes('Giocatori') ? 'players' :
                                   activeTab.textContent.includes('Indovina') ? 'indovina' :
                                   activeTab.textContent.includes('Statistiche') ? 'stats' : 'control';
                    loadTabData(tabName);
                    showNotification('Dati aggiornati');
                }
            }
        });

        // Cleanup quando si lascia la pagina
        window.addEventListener('beforeunload', function() {
            stopAutoRefresh();
        });

        // Gestione errori globale
        window.addEventListener('error', function(e) {
            console.error('Errore JavaScript:', e.error);
            showNotification('Si è verificato un errore. Ricarica la pagina se il problema persiste.', 'error');
        });

        // Auto-aggiornamento punti ordine indizi
        document.getElementById('clue-order').addEventListener('change', function() {
            const order = parseInt(this.value);
            const points = [50, 40, 30, 20, 10];
            document.getElementById('clue-points').value = points[order - 1] || 10;
        });
    </script>
</body>
</html>